<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tebak 4 Angka â€” Mabar Realtime ğŸ’–</title>
<style>
body { font-family: "Poppins", sans-serif; text-align:center; background:#fff; color:#333; transition:.3s; }
.dark { background:#1a1a1a; color:#fff; }
h1 { color:#ff66a3; margin-top:20px; }
button { background:#ff66a3; color:#fff; border:none; padding:10px 20px; margin:6px; border-radius:10px; cursor:pointer; font-weight:bold; transition:.3s; }
button:hover{ transform:scale(1.05);}
input{ padding:10px; margin:10px; border:2px solid #ff66a3; border-radius:8px; width:200px; font-size:16px;}
#feedback-box{ display:flex; justify-content:center; gap:8px; margin-top:15px;}
.feedback-btn{ width:40px; height:40px; background:#ffb6c1; border:none; border-radius:8px; font-size:18px; cursor:pointer;}
.feedback-btn:hover{ background:#ff99bb;}
#announcement{ background:#ffcce0; padding:10px; border-radius:10px; margin:10px auto; width:90%; display:none;}
</style>
</head>
<body>

<h1>ğŸ® Tebak 4 Angka â€” Mabar Realtime ğŸ’–</h1>

<button id="darkToggle">ğŸŒ™ Dark Mode</button>
<button id="musicToggle">ğŸµ Musik</button>
<audio id="bgMusic" src="kasih_putih.mp3" loop></audio>

<div id="announcement"></div>

<div id="lobby">
  <input id="name" placeholder="Nama Kamu"><br>
  <button id="createRoom">ğŸ”‘ Buat Room</button><br><br>
  <input id="roomCodeInput" placeholder="Kode Room..."><br>
  <button id="joinRoom">â¡ï¸ Join Room</button>
</div>

<div id="game" style="display:none;">
  <h3>Room: <span id="roomCodeDisplay"></span></h3>
  <div id="log"></div>
  <input id="guessInput" maxlength="4" placeholder="Tebak 4 angka unik 1â€“9">
  <button id="sendGuess">Kirim Tebakan</button>
  <button id="surrenderBtn">ğŸ˜¢ Menyerah</button>
  <div id="feedback-box">
    <button class="feedback-btn">0</button>
    <button class="feedback-btn">1</button>
    <button class="feedback-btn">2</button>
    <button class="feedback-btn">3</button>
    <button class="feedback-btn">4</button>
  </div>
</div>

<script type="module">
// === Firebase ===
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCqgr3gYyc4oFg69xphOWPctvzgCisyL-I",
  authDomain: "game-tebak-angka-2025.firebaseapp.com",
  databaseURL: "https://game-tebak-angka-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "game-tebak-angka-2025",
  storageBucket: "game-tebak-angka-2025.firebasestorage.app",
  messagingSenderId: "776244941517",
  appId: "1:776244941517:web:d9655d10c9532391084f84",
  measurementId: "G-S6NMHPNG7K"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// === DOM ===
const logDiv = document.getElementById('log');
const roomCodeDisplay = document.getElementById('roomCodeDisplay');
const annBox = document.getElementById('announcement');
const guessInput = document.getElementById('guessInput');
const sendGuess = document.getElementById('sendGuess');
const surrenderBtn = document.getElementById('surrenderBtn');
const feedbackBtns = document.querySelectorAll('.feedback-btn');
const gameDiv = document.getElementById('game');
const lobbyDiv = document.getElementById('lobby');

const nameInput = document.getElementById('name');
const createBtn = document.getElementById('createRoom');
const joinBtn = document.getElementById('joinRoom');
const roomInput = document.getElementById('roomCodeInput');

let playerName = "";
let currentRoom = null;
let playerSecret = "";

// === Utils ===
function showAnnounce(msg){
  annBox.textContent = msg;
  annBox.style.display = "block";
  setTimeout(()=>{ annBox.style.display="none"; },4000);
}
function log(msg){ logDiv.innerHTML += `<div>${msg}</div>`; }

// === DARK MODE & MUSIC ===
const darkToggle = document.getElementById("darkToggle");
const musicToggle = document.getElementById("musicToggle");
const bgMusic = document.getElementById("bgMusic");
darkToggle.onclick = ()=>document.body.classList.toggle("dark");
musicToggle.onclick = ()=>{ bgMusic.paused?bgMusic.play():bgMusic.pause(); };

// === ROOM ===
function generateSecret(){
  const digits = ['1','2','3','4','5','6','7','8','9'];
  let s = "";
  while(s.length<4){
    const d = digits[Math.floor(Math.random()*digits.length)];
    if(!s.includes(d)) s+=d;
  }
  return s;
}

// Create room
createBtn.onclick = async ()=>{
  if(!nameInput.value) return alert("Masukkan nama!");
  playerName = nameInput.value;
  const code = Math.floor(1000+Math.random()*9000);
  playerSecret = generateSecret();
  await set(ref(db,"rooms/"+code),{
    status:"waiting",
    players:{ [playerName]: playerSecret },
    turn: playerName
  });
  joinRoomFunc(code);
};

// Join room
joinBtn.onclick = async ()=>{
  if(!nameInput.value) return alert("Masukkan nama!");
  const code = roomInput.value.trim();
  const snap = await ref(db,"rooms/"+code).get();
  playerName = nameInput.value;
  playerSecret = generateSecret();
  await set(ref(db,"rooms/"+code+"/players/"+playerName), playerSecret);
  joinRoomFunc(code);
};

// === Join Room Function ===
function joinRoomFunc(code){
  currentRoom = code;
  roomCodeDisplay.textContent = code;
  lobbyDiv.style.display = "none";
  gameDiv.style.display = "block";

  const roomRef = ref(db,"rooms/"+code);

  onValue(roomRef, snap=>{
    const data = snap.val();
    if(!data) return;
    log("Pemain di room: "+Object.keys(data.players).join(", "));
  });

  // Send guess
  sendGuess.onclick = async ()=>{
    const guess = guessInput.value.trim();
    if(guess.length!==4) return showAnnounce("Tebakan harus 4 angka unik!");
    const roomSnap = await ref(db,"rooms/"+code).get();
    const roomData = roomSnap.val();
    // Realtime push guess
    await push(ref(db,"rooms/"+code+"/guesses"), { player: playerName, guess });
    log(playerName+" menebak: "+guess);
    guessInput.value="";
  };

  // Feedback buttons
  feedbackBtns.forEach(btn=>{
    btn.onclick = async ()=>{
      const count = Number(btn.textContent);
      if(isNaN(count)) return;
      await push(ref(db,"rooms/"+code+"/feedbacks"), { player: playerName, match: count });
      showAnnounce("Feedback "+count+" terkirim!");
    };
  });

  // Surrender
  surrenderBtn.onclick = async ()=>{
    if(confirm("Apakah kamu yakin menyerah?")){
      await update(ref(db,"rooms/"+code), { status:"ended", winner: "bot/other" });
      showAnnounce("ğŸ˜ Kamu kalah!");
    }
  };
}
</script>
</body>
</html>
