<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tebak 4 Angka — vs Bot & Mabar</title>
<style>
/* ===== CSS utama ===== */
body { font-family: "Poppins", sans-serif; background: linear-gradient(135deg, #ffe6f0, #ffd7e5); display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
.screen { display: none; text-align: center; background: #fff; padding: 24px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); width: 380px; max-height: 90vh; overflow-y: auto; position: relative; }
.active { display: block; }
h1 { color: #b30057; font-size: 24px; margin-bottom: 12px; }
input[type=text] { text-align: center; width: 80%; font-size: 20px; padding: 10px; margin: 8px; border: 2px solid #ffcce0; border-radius: 10px; }
button { background: #ff7aa2; color: white; border: none; border-radius: 8px; padding: 10px 18px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: 0.2s; }
button:hover { background: #ff5d8a; transform: scale(1.05); }
.num-btn { width: 50px; height: 50px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; border: 1px solid #eee; cursor: pointer; margin: 6px; background: #fff0f5; color: #b30057; transition: all .2s; }
.num-btn:hover { background: #ffd6e8; transform: scale(1.1); }
.table-secret { display: flex; justify-content: center; gap: 8px; margin: 10px 0 20px; }
.table-secret div { background: #d2b48c; color: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; border-radius: 6px; font-weight: 700; }
.bot-box { background: linear-gradient(135deg, #ffccd5, #d2b48c); color: #5a2c2c; border-radius: 10px; padding: 20px; font-size: 26px; font-weight: 800; width: 160px; margin: 12px auto; }
.history { background: #fff6f9; border-radius: 10px; padding: 10px; margin-top: 12px; text-align: left; max-height: 180px; overflow-y: auto; font-size: 14px; line-height: 1.6; }
.history span { color: #b30057; font-weight: 600; }
.rules { text-align: left; background: #fff0f5; border-radius: 10px; padding: 12px 16px; margin-top: 14px; font-size: 14px; color: #5a2c2c; }
.guess-grid { display: flex; justify-content: center; gap: 8px; margin: 12px 0; }
.guess-grid input { width: 50px; height: 50px; border-radius: 10px; font-size: 22px; font-weight: bold; border: 2px solid #ffb6c1; color: #b30057; text-align: center; }
#playerNameDisplay { position: absolute; top: 12px; left: 12px; color: #b30057; font-weight: 700; font-size: 14px; }
.surrender-btn { position: absolute; top: 10px; right: 14px; background: #ff5d8a; color: white; border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
/* Lightbox popup tengah */
#lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 240, 245, 0.3); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 999; }
#lightbox img { width: 320px; max-width: 90%; border-radius: 16px; border: 4px solid #ff7aa2; box-shadow: 0 8px 25px rgba(0,0,0,0.2); animation: pop .3s ease; }
@keyframes pop {from{opacity:0;transform:scale(0.9);}to{opacity:1;transform:scale(1);} }
.verse { margin-top: 12px; background: #fff0f5; border-radius: 10px; padding: 10px; color: #5a2c2c; font-size: 13px; font-style: italic; }
#endScreen img, #cheatScreen img, #surrenderScreen img { width: 160px; height: 160px; border-radius: 50%; margin: 16px 0; object-fit: cover; border: 4px solid #ff7aa2; cursor: pointer; transition: 0.3s; }
#endScreen img:hover, #cheatScreen img:hover, #surrenderScreen img:hover { transform: scale(1.05); }
#endDetails, #cheatDetails, #surrenderDetails { background: #fff0f5; border-radius: 10px; padding: 10px; color: #5a2c2c; font-weight: 600; margin-top: 8px; }
#errorScreen { background: #8b0000; color: #fff; text-align: center; }
.btn-row { display: flex; justify-content: center; gap: 10px; margin-top: 14px; }

/* Multiplayer screen specific styles */
.multiplayer-block { background: #fff0f5; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
.room-code { font-size: 28px; font-weight: bold; color: #b30057; margin: 10px 0; padding: 10px; border: 2px dashed #ffcce0; border-radius: 8px; display: inline-block; cursor: pointer; }
.join-input { width: 70%; padding: 10px; font-size: 18px; border: 2px solid #ffcce0; border-radius: 10px; text-align: center; margin-bottom: 10px; }

/* Waiting screen styles */
#waitScreen { background: linear-gradient(135deg, #e6f0ff, #d7e5ff); color: #0057b3; }
#waitScreen h1 { color: #0057b3; }
.spinner { border: 8px solid #f3f3f3; border-top: 8px solid #b30057; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; margin: 20px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.wait-text { font-size: 18px; font-weight: 600; margin-top: 10px; }

/* Overlay Wait */
#mabarWaitOverlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(2px);
    z-index: 10;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    border-radius: 16px;
    color: #b30057;
    font-weight: bold;
}
#mabarWaitOverlay .spinner { border-top: 8px solid #b30057; width: 30px; height: 30px; margin-bottom: 10px;}


/* ===== Switch pojok kiri atas ===== */
#topSwitches { position: fixed; top: 12px; left: 12px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
.switch { position: relative; display: inline-block; width: 60px; height: 28px; }
.switch input { display: none; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ffb6c1; border-radius: 34px; transition: 0.3s; }
.slider:before { position: absolute; content: "🌙"; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.3s; }
input:checked + .slider { background-color: #b30057; }
input:checked + .slider:before { transform: translateX(32px); content: "☀️"; }
.slider.music { background-color: #ffd1dc; }
.slider.music:before { content: "🎵"; }
input:checked + .slider.music:before { content: "🔊"; }
/* Mode gelap */
body.dark { background: linear-gradient(135deg, #2b002b, #4a004a); color: #f8d8e8; }
body.dark .screen { background: #3a003a; color: #f8d8e8; box-shadow: 0 6px 15px rgba(0,0,0,0.4); }
body.dark button { background: #a34a78; color: white; }
body.dark button:hover { background: #c15a8f; }
body.dark .history { background: #4a004a; color: #fbd7e8; }
body.dark .rules { background: #4a004a; color: #ffe6f0; }
body.dark .multiplayer-block { background: #4a004a; }
body.dark .room-code { color: #f8d8e8; border: 2px dashed #a34a78; }
body.dark #mabarWaitOverlay { background: rgba(0, 0, 0, 0.8); color: #ff7aa2; }
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
</head>
<body onbeforeunload="cleanupRoom()">

<div id="topSwitches">
  <label class="switch">
    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
    <span class="slider"></span>
  </label>
  <label class="switch">
    <input type="checkbox" id="musicToggle" onchange="toggleMusic()">
    <span class="slider music"></span>
  </label>
</div>

<audio id="bgMusic" src="Kasih Putih (Acoustic).mp3" loop></audio>

<div id="playerNameDisplay"></div>

<div id="welcome" class="screen active">
  <h1>🎮 Selamat Datang di Game Tebak 4 Angka 🎀</h1>
  <p>Pilih mode permainan:</p>
  <div class="btn-row" style="flex-direction:column; gap:15px;">
    <div style="background: #fff0f5; padding: 20px; border-radius: 10px;">
      <h3>Melawan Bot 🤖</h3>
      <input id="name_bot" type="text" placeholder="Nama Pemain"><br>
      <input id="secret_bot" type="text" maxlength="4" placeholder="Angka Kamu"><br>
      <button onclick="startGame(false)">Mulai Game (vs Bot) ▶️</button>
    </div>
    <button onclick="show('multiplayerSetup')">Mabar (Multiplayer) 👯</button>
  </div>
  <div class="btn-row">
    <button onclick="showHistoryScreen()">📜 Riwayat</button>
  </div>
  <div class="rules">
    <h2>📜 Peraturan & Petunjuk:</h2>
    <ul>
      <li>Gunakan angka <b>1–9</b> (tidak boleh 0 dan tidak boleh ganda).</li>
      <li>Pemain dan lawan bergantian menebak angka satu sama lain.</li>
      <li>Jika hasil <b>4</b>, maka pemain yang menebak <b>MENANG!</b> 🎉</li>
    </ul>
  </div>
</div>

<div id="multiplayerSetup" class="screen">
  <h1>👯 Mabar (Multiplayer)</h1>
  <p>Pilih mode koneksi:</p>
  
    <div class="multiplayer-block">
    <h3>🔑 Buat Room Baru (Host)</h3>
    <p id="hostRoomCodeDisplay">Tekan tombol untuk membuat kode.</p>
    <button id="generateRoomBtn" onclick="generateRoom()">Generate Room</button>
    <button id="hostStartBtn" style="display:none;" onclick="showNameSecretSetup('host')">Masuk Room ▶️</button>
  </div>
  
  ---
  
    <div class="multiplayer-block">
    <h3>🚪 Gabung Room</h3>
    <input id="joinRoomInput" type="text" class="join-input" maxlength="4" placeholder="Masukkan Kode Party"><br>
    <button onclick="showNameSecretSetup('join')">Gabung Room ▶️</button>
  </div>
  
  <button onclick="cleanupAndShow('welcome')">⬅️ Kembali</button>
</div>

<div id="mabarNameSecret" class="screen">
  <h1>🎮 Siap Mabar!</h1>
  <p>Masukkan namamu dan angka rahasiamu:</p>
  <input id="name_mabar" type="text" placeholder="Nama Pemain"><br>
  <input id="secret_mabar" type="text" maxlength="4" placeholder="Angka Kamu"><br>
  <button id="mabarStartGameBtn" onclick="startMultiplayerGame()">Mulai Game Mabar ▶️</button>
  <button onclick="cleanupAndShow('multiplayerSetup')">⬅️ Kembali</button>
</div>

<div id="waitScreen" class="screen">
  <h1>⏳ Tunggu Lawan</h1>
  <div class="spinner"></div>
  <p class="wait-text" id="waitMessage">Menunggu pemain lain bergabung...</p>
  <button onclick="cleanupAndShow('multiplayerSetup')">Batalkan dan Kembali</button>
</div>

<div id="lightbox" onclick="this.style.display='none'">
  <img id="lightboxImg" src="">
</div>

<div id="historyScreen" class="screen">
  <h1>📜 Riwayat Permainan</h1>
  <div id="historyList"></div>
  <button onclick="show('welcome')">⬅️ Kembali</button>
</div>

<div id="playerTurn" class="screen">
    <div id="mabarWaitOverlay">
        <div class="spinner"></div>
        <p id="playerWaitText">Menunggu lawan...</p>
    </div>
  <div class="surrender-btn" onclick="confirmSurrender()">🏳️ Menyerah</div>
  <h1 id="turnHeader">Tebak Angka Lawan 🎯</h1>
  <div class="guess-grid">
    <input id="g1" maxlength="1">
    <input id="g2" maxlength="1">
    <input id="g3" maxlength="1">
    <input id="g4" maxlength="1">
  </div>
  <button id="guessBtn" onclick="submitGuess()">Kirim Tebakan</button>
  <p id="result"></p>
  <button id="doneBtn" style="display:none;" onclick="afterOpponentFeedback()">Sudah ✅</button>
  <h3 id="playerHistHeader">Riwayat Tebakanmu:</h3>
  <div class="history" id="playerHistory"></div>
</div>

<div id="botTurn" class="screen" style="background:linear-gradient(135deg,#ffe6f0,#d2b48c);">
    <div id="mabarWaitOverlayBot">
        <div class="spinner"></div>
        <p id="botWaitText">Menunggu lawan...</p>
    </div>
  <div class="surrender-btn" onclick="confirmSurrender()">🏳️ Menyerah</div>
  <h1 id="opponentTurnHeader">Giliran Lawan 🔮</h1>
  <p>Angka rahasiamu:</p>
  <div id="playerSecretTable" class="table-secret"></div>
  <div class="bot-box" id="botGuess">----</div>
  <p id="feedbackPrompt">Beri tahu lawan berapa angka yang benar:</p>
  <div id="feedbackArea"></div>
  <button id="nextTurnBtn" style="display:none;" onclick="nextTurn()">Sudah ✅</button>
  <h3 id="opponentHistHeader">Riwayat Tebakan Lawan:</h3>
  <div class="history" id="botHistory"></div>
</div>

<div id="cheatScreen" class="screen">
  <img src="IMG-20251006-WA0031.jpg" alt="Jangan Curang" onclick="openLightbox(this)">
  <h1>🚫 Jangan Curang!</h1>
  <div id="cheatDetails">
    <p>Kamu memberi feedback yang salah... 😔<br>Ingatlah untuk bermain jujur ya!</p>
    <blockquote><b>Amsal 12:22</b> — "Bibir dusta adalah kekejian bagi TUHAN, tetapi orang yang berlaku setia dikenan-Nya."</blockquote>
  </div>
  <div class="verse">💡 “Hendaklah integritasmu nyata di setiap hal kecil.”</div>
  <button onclick="forgiveCheat()">🙏 Saya Bertobat</button>
</div>

<div id="surrenderScreen" class="screen">
  <img src="IMG-20251016-WA0019.jpg" alt="Menyerah" onclick="openLightbox(this)">
  <h1>😢 Yakin nih mau nyerah?</h1>
  <div id="surrenderDetails">
    <p>Kalau menyerah, kamu langsung dinyatakan kalah loh!</p>
  </div>
  <div class="verse">📖 <b>Filipi 4:13</b> — “Segala perkara dapat kutanggung di dalam Dia yang memberi kekuatan kepadaku.”</div>
  <div class="btn-row">
    <button onclick="cancelSurrender()">Tidak 😤</button>
    <button onclick="giveUp()">Iya 😔</button>
  </div>
</div>

<div id="endScreen" class="screen">
  <img id="endImg" src="" alt="Foto Akhir" onclick="openLightbox(this)">
  <h1 id="endMsg"></h1>
  <div id="endDetails"></div>
  <div id="endVerse" class="verse"></div>
  <button onclick="location.reload()">Main Lagi 🔁</button>
</div>

<div id="errorScreen" class="screen">
  <h1 id="errorMsg"></h1>
  <button onclick="closeError()">Baiklah 😅</button>
</div>

<script>
/* ===== Script game & switch ===== */
function openLightbox(img){document.getElementById('lightboxImg').src=img.src;document.getElementById('lightbox').style.display='flex';}
function toggleDarkMode(){document.body.classList.toggle("dark");}
function toggleMusic(){
  const audio=document.getElementById("bgMusic");document.getElementById("musicToggle").checked ? audio.play() : audio.pause();}

// Inisialisasi Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCqgr3gYyc4oFg69xphOWPctvzgCisyL-I",
  authDomain: "game-tebak-angka-2025.firebaseapp.com",
  databaseURL: "https://game-tebak-angka-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "game-tebak-angka-2025",
  storageBucket: "game-tebak-angka-2025.firebasestorage.app",
  messagingSenderId: "776244941517",
  appId: "1:776244941517:web:d9655d10c9532391084f84",
  measurementId: "G-S6NMHPNG7K"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const analytics = firebase.analytics();


/* Generate semua kombinasi 4 angka unik */
const all = [];
(function gen() {
  const d = ['1','2','3','4','5','6','7','8','9'];
  function back(c) {
    if(c.length === 4){ all.push(c.join('')); return; }
    for(const x of d) if(!c.includes(x)){ c.push(x); back(c); c.pop(); }
  }
  back([]);
})();

let playerSecret = "", botSecret = "", possible = [...all], botLast = "";
let playerName = "", isMultiplayer = false, roomCode = "", playerID = null;
let roomData = null; // Data room dari Firebase
const playerHist = document.getElementById('playerHistory');
const botHist = document.getElementById('botHistory');

function isValid(s){ return /^[1-9]{4}$/.test(s) && new Set(s).size===4; }
function match(a,b){ let c=0; for(let i=0;i<4;i++) if(a[i]===b[i]) c++; return c; }
function show(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function error(msg){ document.getElementById('errorMsg').textContent=msg; show('errorScreen'); }
function closeError(){ 
  if(isMultiplayer) { 
    if (roomData && roomData.status === 'playing') showTurnScreen(roomData.turn === playerID);
    else if (roomData && roomData.status === 'ready_to_start') show('mabarNameSecret');
    else show('waitScreen');
  } else if (playerSecret) {
    show('playerTurn');
  } else {
    show('welcome'); 
  }
}
function cleanupAndShow(id) {
  cleanupRoom();
  show(id);
}

function setupSecretTable(secret, elementId) {
  const tbl = document.getElementById(elementId);
  tbl.innerHTML = "";
  for(let ch of secret){ const cell=document.createElement('div'); cell.textContent=ch; tbl.appendChild(cell); }
}

// ==========================================================
// LOGIKA GAME UMUM (Bot dan Mabar)
// ==========================================================

function startGame(isMabar) {
  isMultiplayer = isMabar;
  let n, sec;

  if (!isMabar) {
    n = document.getElementById('name_bot').value.trim();
    sec = document.getElementById('secret_bot').value.trim();
  } else {
    n = document.getElementById('name_mabar').value.trim();
    sec = document.getElementById('secret_mabar').value.trim();
  }

  if(!n) return error("Nama tidak boleh kosong!");
  if(!isValid(sec)) return error("Angka rahasia harus 4 angka unik (1–9, tanpa 0)!");
  
  playerName = n; 
  playerSecret = sec;
  document.getElementById('playerNameDisplay').textContent = (isMabar ? `[${roomCode}] ` : "") + "👤 " + playerName;
  playerHist.innerHTML = "";
  botHist.innerHTML = "";
  setupSecretTable(playerSecret, 'playerSecretTable');


  if (!isMabar) {
    // Setup VS BOT
    botSecret = all[Math.floor(Math.random()*all.length)];
    possible = [...all]; // Reset possible guesses for bot
    document.getElementById('turnHeader').textContent = "Tebak Angka Bot 🎯";
    document.getElementById('opponentTurnHeader').textContent = "Giliran Bot 🔮";
    document.getElementById('feedbackPrompt').textContent = "Beri tahu bot berapa angka yang benar:";
    document.getElementById('playerHistHeader').textContent = "Riwayat Tebakanmu:";
    document.getElementById('opponentHistHeader').textContent = "Riwayat Tebakan Bot:";
    show('playerTurn'); g1.focus();
  } else {
    // Setup MULTIPLAYER
    const updates = {
      status: 'playing', 
      [`player${playerID}_name`]: playerName,
      [`player${playerID}_secret`]: playerSecret,
    };
    updateRoomData(updates);
    setupMultiplayerListeners(); // Mulai mendengarkan pembaruan
  }
}

function submitGuess() {
  const g = [g1.value,g2.value,g3.value,g4.value].join('');
  if(!isValid(g)) return error("Tebakan harus 4 angka unik (1–9, tanpa 0)!");
  
  let targetSecret = isMultiplayer ? roomData.opponentSecret : botSecret;
  const m = match(g, targetSecret);

  document.getElementById('result').textContent = `Hasil: ${m}`;
  // Riwayat akan di-update oleh listener Firebase di mode Mabar
  if (!isMultiplayer) playerHist.innerHTML += `<div><span>${g}</span> → ${m}</div>`; 
  
  document.getElementById('guessBtn').style.display = 'none';
  if(m === 4){ 
    end("Kamu menang! 🎉", true); 
    if(isMultiplayer) updateRoomData({winner: playerName, status: 'ended'});
    return; 
  }

  if (isMultiplayer) {
    // Kirim tebakan ke lawan (Firebase)
    updateRoomData({
      turn: roomData.opponentID, // Pindah giliran ke lawan
      lastGuess: g,
      state: 'feedback_needed', // Lawan harus beri feedback
      [`player${playerID}_typing`]: false, // Berhenti mengetik
      history: [...(roomData.history || []), {guesser: playerName, guess: g, result: m}], // Result di history P1 untuk check
    });
    // Di PlayerTurn screen, wait overlay akan muncul otomatis karena turn != playerID
    // showWaitScreen(`Menunggu ${roomData.opponentName} memberikan feedback...`);
  } else {
    // VS BOT
    document.getElementById('doneBtn').style.display = 'inline-block';
  }
}

function afterOpponentFeedback(){ 
  // Dipanggil setelah klik 'Sudah' di VS BOT
  document.getElementById('doneBtn').style.display='none'; 
  clearGuess(); 
  showOpponentTurn(); 
}

function showOpponentTurn() {
  if (!isMultiplayer) {
    // Giliran BOT
    botLast = possible[Math.floor(Math.random()*possible.length)];
    document.getElementById('botGuess').textContent = botLast;
    const fb = document.getElementById('feedbackArea'); fb.innerHTML = '';
    document.getElementById('nextTurnBtn').style.display='none';
    for(let i=0;i<=4;i++){
      const b=document.createElement('div');
      b.className='num-btn';
      b.textContent=i;
      b.onclick=()=>feedback(i);
      fb.appendChild(b);
    }
    show('botTurn');
  } else {
    // Giliran LAWAN (Mabar) - Dipicu oleh listener Firebase
    // Update tampilan di botTurn screen untuk meminta feedback
    document.getElementById('opponentTurnHeader').textContent = `Giliran ${roomData.opponentName} 🔮`;
    document.getElementById('feedbackPrompt').textContent = `Beri tahu ${roomData.opponentName} berapa angka yang benar:`;
    
    // Pastikan tebakan terakhir ada
    if (!roomData.lastGuess) {
      // Jika entah kenapa tidak ada, pindah ke wait screen
      showWaitScreen(`Menunggu ${roomData.opponentName} mengirim tebakan...`);
      return;
    }

    document.getElementById('botGuess').textContent = roomData.lastGuess;
    const fb = document.getElementById('feedbackArea'); fb.innerHTML = '';
    document.getElementById('nextTurnBtn').style.display='none';

    for(let i=0;i<=4;i++){
      const b=document.createElement('div');
      b.className='num-btn';
      b.textContent=i;
      b.onclick=()=>feedback(i, roomData.lastGuess);
      fb.appendChild(b);
    }
    show('botTurn');
  }
}

function feedback(f, guess = botLast){
  const realMatch = match(guess, playerSecret);

  if(f !== realMatch){ show('cheatScreen'); return; }

  if (!isMultiplayer) {
    // VS BOT
    const filtered = possible.filter(x=>match(x, botLast)===f);
    botHist.innerHTML += `<div><span>${botLast}</span> → ${f}</div>`;
    if(f===4){ end("Bot menang! 🤖", false); return; }
    possible = filtered;
    document.getElementById('nextTurnBtn').style.display='inline-block';
  } else {
    // MULTIPLAYER
    // Cek apakah feedback ini konsisten dengan history P1 (pencegahan cheat minimal)
    const lastRecord = roomData.history[roomData.history.length - 1];
    if (lastRecord.guesser === roomData.opponentName && lastRecord.result !== f) {
      // Pencegahan cheat jika P2 memberi feedback yang berbeda dari hasil perhitungan P1
      // Catatan: Logika ini bisa disempurnakan.
    }

    // Kirim feedback ke lawan (Firebase)
    updateRoomData({
      turn: playerID, // Kembali ke giliranmu untuk menebak
      lastFeedback: f,
      state: 'guess_received', // Lawan akan menerima ini dan melihat hasil tebakannya
      [`player${roomData.opponentID}_typing`]: false, // Matikan status mengetik lawan
    });

    // Jika menang (lawan menang)
    if(f===4){ 
      end(`${roomData.opponentName} menang! 🤖`, false); 
      updateRoomData({winner: roomData.opponentName, status: 'ended'});
      return; 
    }

    // Jika feedback sudah dikirim, tunggu giliranmu menebak
    showWaitScreen(`Feedback terkirim. Menunggu giliranmu...`); 
  }
}

function forgiveCheat(){ 
  // Di mode mabar, kembali ke layar feedback
  if (isMultiplayer) {
    updateRoomData({state: 'feedback_needed'}); // Coba ulangi feedback
    showOpponentTurn();
  } else {
    show('botTurn'); 
  }
}
function confirmSurrender(){ show('surrenderScreen'); }
function cancelSurrender(){ 
  // Logic kembali ke layar terakhir
  if (!isMultiplayer) {
    show(playerSecret && botLast ? 'botTurn':'playerTurn'); 
  } else if (roomData && roomData.status === 'playing') {
    showTurnScreen(roomData.turn === playerID);
  }
}
function giveUp(){ 
  end("Kamu menyerah 😔", false); 
  if(isMultiplayer) updateRoomData({winner: roomData.opponentName, status: 'ended'});
  cleanupRoom();
}

function nextTurn(){ 
  // Hanya untuk VS BOT
  show('playerTurn'); 
  document.getElementById('guessBtn').style.display='inline-block'; 
  clearGuess(); g1.focus(); 
}
function clearGuess(){ g1.value=g2.value=g3.value=g4.value=''; document.getElementById('result').textContent=''; }

function end(msg, win){
  const img=document.getElementById('endImg');
  img.src=win?"IMG-20251016-WA0037.jpg":"motion_photo_7499955795629952970.jpg";
  document.getElementById('endMsg').textContent=msg;

  let p1Name, p2Name, p1Secret, p2Secret;

  if (isMultiplayer) {
    // Asumsi playerID 1 dan 2 sudah terisi di roomData
    p1Name = roomData.player1_name;
    p2Name = roomData.player2_name;
    p1Secret = roomData.player1_secret;
    p2Secret = roomData.player2_secret;
  } else {
    p1Name = playerName;
    p2Name = "Bot";
    p1Secret = playerSecret;
    p2Secret = botSecret;
  }

  document.getElementById('endDetails').innerHTML=`<p>🔢 Angka ${p1Name}: <b>${p1Secret}</b><br>🔢 Angka ${p2Name}: <b>${p2Secret}</b></p>`;
  
  document.getElementById('endVerse').innerHTML = win
    ? "📖 <b>Roma 8:37</b> — 'Tetapi dalam semuanya itu kita lebih dari pada orang-orang yang menang, oleh Dia yang telah mengasihi kita.'"
    : "📖 <b>Yeremia 29:11</b> — 'Sebab Aku ini mengetahui rancangan-rancangan apa yang ada pada-Ku mengenai kamu, demikianlah firman TUHAN, yaitu rancangan damai sejahtera dan bukan rancangan kecelakaan.'";
  
  db.ref('rooms/' + roomCode).off('value'); // Stop listener
  show('endScreen');
}

/* Riwayat */
function showHistoryScreen(){
  const list = document.getElementById('historyList');
  let histContent = "";

  if(isMultiplayer && roomData && roomData.history) {
    histContent += `<h3>${roomData.player1_name} vs ${roomData.player2_name} (${roomCode})</h3>`;
    let player1Hist = "<h4>Tebakan Player 1:</h4>", player2Hist = "<h4>Tebakan Player 2:</h4>";
    for (const record of roomData.history) {
      const html = `<div><span>${record.guess}</span> → ${record.result}</div>`;
      if (record.guesser === roomData.player1_name) {
        player1Hist += html;
      } else {
        player2Hist += html;
      }
    }
    histContent += player1Hist + player2Hist;
  } else if (!isMultiplayer) {
    histContent += `<h3>${playerName} vs Bot</h3><h4>Tebakan Pemain:</h4>${playerHist.innerHTML || "(belum ada)"}<h4>Tebakan Bot:</h4>${botHist.innerHTML || "(belum ada)"}`;
  }

  if(histContent === ""){ 
    list.innerHTML = "<p>Belum ada permainan yang dimulai.</p>"; 
  } else { 
    list.innerHTML = histContent;
  }

  show('historyScreen');
}

/* Auto-pindah fokus saat input tebakan */
const guessInputs = [g1,g2,g3,g4];
guessInputs.forEach((input, idx)=>{
  input.addEventListener('input', ()=>{
    if(input.value.length===1 && idx<guessInputs.length-1){ guessInputs[idx+1].focus(); }
  });
});


// ==========================================================
// LOGIKA MULTIPLAYER (MABAR)
// ==========================================================

let mode = ""; // 'host' atau 'join'

function generateRoomCode() {
  return Math.random().toString(36).substring(2, 6).toUpperCase();
}

function generateRoom() {
  roomCode = generateRoomCode();
  sessionStorage.setItem('currentRoomCode', roomCode); // Simpan kode
  playerID = 1; // Host selalu P1
  mode = 'host';

  // Set initial room data
  db.ref('rooms/' + roomCode).set({
    status: 'waiting_join',
    turn: 1, // P1 selalu mulai
    state: 'setup',
    history: [],
    player1_name: "Host",
    player2_name: "Tamu",
    player1_typing: false,
    player2_typing: false,
    lastGuess: null,
    lastFeedback: null,
  }).then(() => {
    document.getElementById('hostRoomCodeDisplay').innerHTML = `Kode Room:<div class="room-code" onclick="copyCode('${roomCode}')">${roomCode}</div>(klik untuk salin)`;
    document.getElementById('hostStartBtn').style.display = 'inline-block';
    // Tambahkan listener untuk menunggu P2
    db.ref('rooms/' + roomCode).on('value', hostWaitingListener);
  }).catch(e => error("Gagal membuat room: " + e.message));
}

function hostWaitingListener(snapshot) {
  roomData = snapshot.val();
  if (!roomData) return;
  
  if (roomData.status === 'ready_to_start' && mode === 'host') {
    // P2 sudah bergabung dan siap
    const btn = document.getElementById('hostStartBtn');
    btn.textContent = `Lanjut ke Game vs ${roomData.player2_name} ▶️`;
    btn.disabled = false;
    show('multiplayerSetup'); // Pastikan tetap di setup screen
  } else if (roomData.status === 'playing') {
    // Jika host sudah masuk ke layar setup tapi game sudah dimulai (misalnya P2 sudah masuk)
    show('mabarNameSecret');
    document.getElementById('mabarStartGameBtn').click(); // Langsung klik start
  }
}

function copyCode(code) {
  navigator.clipboard.writeText(code).then(() => {
    alert('Kode Room disalin: ' + code);
  });
}

function showNameSecretSetup(m) {
  mode = m;
  if (mode === 'join') {
    roomCode = document.getElementById('joinRoomInput').value.trim().toUpperCase();
    if (roomCode.length !== 4) return error("Kode room harus 4 karakter.");
    
    // Cek room di Firebase
    db.ref('rooms/' + roomCode).once('value').then(snapshot => {
      roomData = snapshot.val();
      if (!roomData || roomData.status !== 'waiting_join') {
        return error("Room tidak ditemukan atau sudah penuh/dimulai!");
      }
      playerID = 2; // Gabung selalu P2
      sessionStorage.setItem('currentRoomCode', roomCode);
      show('mabarNameSecret');
    }).catch(e => {
      error("Gagal koneksi ke server: " + e.message);
    });
  } else {
    // Host
    if (!roomCode) return error("Harap generate room code terlebih dahulu!");
    // Stop listener host waiting, tidak perlu lagi
    db.ref('rooms/' + roomCode).off('value', hostWaitingListener); 
    show('mabarNameSecret');
  }
}

function startMultiplayerGame() {
  playerName = document.getElementById('name_mabar').value.trim();
  playerSecret = document.getElementById('secret_mabar').value.trim();
  
  if(!playerName) return error("Nama tidak boleh kosong!");
  if(!isValid(playerSecret)) return error("Angka rahasia harus 4 angka unik (1–9, tanpa 0)!");

  if (mode === 'join') {
    // P2 update status, nama, dan secret
    updateRoomData({
      status: 'ready_to_start',
      player2_name: playerName,
      player2_secret: playerSecret,
    });
    
    showWaitScreen(`Menunggu Host (${roomData.player1_name}) memulai game...`);
    
    // Listener di P2 untuk menunggu Host Start
    db.ref('rooms/' + roomCode).on('value', snapshot => {
      roomData = snapshot.val();
      if (roomData && roomData.status === 'playing') {
        // Host sudah start, inisialisasi game P2
        setupRoomContext();
        startGame(true); // Mulai game!
      }
    });

  } else if (mode === 'host') {
    // Host (P1)
    if(roomData.status !== 'ready_to_start') {
      return error("Room masih menunggu pemain lain bergabung!");
    }
    
    // P1 update nama dan secret, lalu start game
    updateRoomData({
      status: 'playing',
      player1_name: playerName,
      player1_secret: playerSecret,
    });

    setupRoomContext();
    startGame(true);
  }
}

function setupRoomContext() {
  if (playerID === 1) {
    roomData.opponentName = roomData.player2_name;
    roomData.opponentSecret = roomData.player2_secret;
    roomData.opponentID = 2;
  } else if (playerID === 2) {
    roomData.opponentName = roomData.player1_name;
    roomData.opponentSecret = roomData.player1_secret;
    roomData.opponentID = 1;
  }
  document.getElementById('turnHeader').textContent = `Tebak Angka ${roomData.opponentName} 🎯`;
  document.getElementById('playerHistHeader').textContent = `Riwayat Tebakanmu (${playerName}):`;
  document.getElementById('opponentTurnHeader').textContent = `Giliran ${roomData.opponentName} 🔮`;
  document.getElementById('opponentHistHeader').textContent = `Riwayat Tebakan ${roomData.opponentName}:`;
}


function showWaitScreen(message) {
  document.getElementById('waitMessage').textContent = message;
  show('waitScreen');
}

// Fungsi untuk update data di Firebase
function updateRoomData(updates) {
  db.ref('rooms/' + roomCode).update(updates).catch(e => {
    error("Gagal update data room: " + e.message);
  });
}

// Menentukan tampilan giliranmu atau giliran lawan
function showTurnScreen(isMyTurn) {
  setTypingStatus(false); // Matikan status typing sebelum pindah layar
  setupSecretTable(playerSecret, 'playerSecretTable');

  if (isMyTurn) {
    // Giliranmu untuk menebak
    document.getElementById('guessBtn').style.display='inline-block';
    document.getElementById('doneBtn').style.display='none';
    clearGuess(); g1.focus();
    show('playerTurn');
    setupGuessInputListeners(); // Aktifkan listener typing
    updateOverlay(); // Sembunyikan overlay
  } else {
    // Giliran lawan untuk feedback
    showOpponentTurn();
    setupFeedbackButtonListeners(); // Aktifkan listener typing
    updateOverlay(); // Sembunyikan overlay
  }
}

// Sinkronisasi status mengetik
function setTypingStatus(isTyping, isFeedback = false) {
  if (!isMultiplayer || !roomCode) return;
  const key = `player${playerID}_typing`;
  const value = isTyping ? (isFeedback ? 'feedback' : 'guess') : false;
  db.ref('rooms/' + roomCode + '/' + key).set(value);
}

function setupGuessInputListeners() {
  const inputs = [g1, g2, g3, g4];
  inputs.forEach(input => {
    input.onfocus = () => setTypingStatus(true, false);
    input.onblur = () => setTypingStatus(false);
  });
}

function setupFeedbackButtonListeners() {
  const buttons = document.getElementById('feedbackArea').querySelectorAll('.num-btn');
  buttons.forEach(button => {
    button.onfocus = () => setTypingStatus(true, true);
    button.onblur = () => setTypingStatus(false);
  });
}

// Listener utama untuk sinkronisasi Mabar
function setupMultiplayerListeners() {
  // Hapus listener lama jika ada
  db.ref('rooms/' + roomCode).off('value');

  db.ref('rooms/' + roomCode).on('value', snapshot => {
    const data = snapshot.val();
    if (!data || data.status === 'setup' || data.status === 'waiting_join') return; 

    roomData = {
      ...data,
      opponentID: playerID === 1 ? 2 : 1,
      opponentName: playerID === 1 ? data.player2_name : data.player1_name,
      opponentSecret: playerID === 1 ? data.player2_secret : data.player1_secret,
      opponentTyping: playerID === 1 ? data.player2_typing : data.player1_typing,
    }

    setupRoomContext(); // Update nama lawan di header

    // 1. Cek Game Ended
    if (data.status === 'ended') {
      if (data.winner === playerName) end("Kamu menang! 🎉", true);
      else if (data.winner) end(`${data.winner} menang! 🤖`, false);
      return;
    }

    // 2. Update Riwayat Tebakan
    updateHistoryDisplay(data.history);

    // 3. Logika Giliran
    const isMyTurn = data.turn === playerID;

    if (isMyTurn) {
      if (data.state === 'feedback_needed') {
        // Lawan baru saja menebak, giliranmu memberi feedback
        showTurnScreen(false);
      } else if (data.state === 'guess_received' || data.state === 'playing') {
        // Lawan sudah memberi feedback, giliranmu menebak
        if (data.lastFeedback !== undefined && data.lastFeedback !== null) {
          // Tampilkan hasil tebakanmu sebelumnya
          document.getElementById('result').textContent = `Hasil tebakanmu: ${data.lastFeedback}`;
          // Reset state agar tidak terus menampilkan hasil, beri jeda untuk lihat result
          setTimeout(() => {
            updateRoomData({state: 'playing', lastFeedback: null, lastGuess: null});
            showTurnScreen(true); // Pindah ke giliran menebak
          }, 1500); // 1.5 detik untuk melihat feedback
        } else {
          showTurnScreen(true); // Pindah ke giliran menebak
        }
      }
    } else {
      // Giliran Lawan, tampilkan wait screen atau biarkan di layar tebakan/feedback lawan
      updateOverlay(); // Tampilkan wait overlay
    }
  });
}

function updateHistoryDisplay(history) {
  playerHist.innerHTML = "";
  botHist.innerHTML = "";
  if (history) {
    for (const record of history) {
      const html = `<div><span>${record.guess}</span> → ${record.result}</div>`;
      if (record.guesser === playerName) {
        playerHist.innerHTML += html;
      } else {
        botHist.innerHTML += html;
      }
    }
  }
}

function updateOverlay() {
  if (!isMultiplayer || !roomData) return;

  const overlayPlayer = document.getElementById('mabarWaitOverlay');
  const overlayBot = document.getElementById('mabarWaitOverlayBot');
  const playerWaitText = document.getElementById('playerWaitText');
  const botWaitText = document.getElementById('botWaitText');
  const isMyTurn = roomData.turn === playerID;
  const opponentTyping = roomData.opponentTyping;

  if (isMyTurn) {
    overlayPlayer.style.display = 'none';
    // Jika giliran saya, tapi lawan sedang mengetik feedback
    if (opponentTyping === 'feedback') {
      overlayPlayer.style.display = 'flex';
      playerWaitText.textContent = `${roomData.opponentName} sedang memberi feedback...`;
    }
    
    // Di layar feedback lawan, sembunyikan overlay
    overlayBot.style.display = 'none';

  } else {
    // Giliran Lawan
    if (currentScreenId === 'playerTurn') {
      // Di layar tebakanku (menunggu giliran lawan menebak)
      overlayPlayer.style.display = 'flex';
      if (opponentTyping === 'guess') {
        playerWaitText.textContent = `${roomData.opponentName} sedang mengetik tebakan...`;
      } else {
        playerWaitText.textContent = `Menunggu ${roomData.opponentName} menebak...`;
      }
    } else if (currentScreenId === 'botTurn') {
      // Di layar feedbackku (menunggu giliran lawan menebak)
      overlayBot.style.display = 'flex';
      if (opponentTyping === 'guess') {
        botWaitText.textContent = `${roomData.opponentName} sedang mengetik tebakan...`;
      } else {
        botWaitText.textContent = `Menunggu ${roomData.opponentName} menebak...`;
      }
    } else {
      // Jika di layar lain, sembunyikan semua
      overlayPlayer.style.display = 'none';
      overlayBot.style.display = 'none';
    }
  }
}

let currentScreenId = 'welcome';
const originalShow = show;
show = function(id) {
  originalShow(id);
  currentScreenId = id;
  if(isMultiplayer) updateOverlay();
}


// Cleanup function: hapus room jika Host keluar
function cleanupRoom() {
  if (isMultiplayer && roomCode && playerID === 1 && roomData && roomData.status !== 'ended') {
    // Hanya host yang menghapus room saat keluar
    db.ref('rooms/' + roomCode).remove();
    db.ref('rooms/' + roomCode).off('value');
  } else if (isMultiplayer && roomCode && playerID === 2 && roomData && roomData.status !== 'ended') {
    // P2 hanya menonaktifkan listener
    db.ref('rooms/' + roomCode).off('value');
  }
  isMultiplayer = false;
  roomCode = "";
  playerID = null;
  roomData = null;
  sessionStorage.removeItem('currentRoomCode');
}
window.onbeforeunload = cleanupRoom;

</script>
</body>
</html>
