<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tebak Angka Mabar</title>
    <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.21.1/firebase-analytics.js"></script>
    <style>
        /* Gaya Dasar */
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --background-color: #f4f4f4;
            --text-color: #333;
            --card-background: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --input-border: #ccc;
        }
        body.dark {
            --primary-color: #66BB6A;
            --secondary-color: #4CAF50;
            --background-color: #121212;
            --text-color: #e0e0e0;
            --card-background: #1e1e1e;
            --shadow-color: rgba(255, 255, 255, 0.1);
            --input-border: #555;
        }

        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 450px;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Gaya Layar */
        .screen {
            background: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            display: none;
            transition: opacity 0.3s;
        }
        .screen.active {
            display: block;
        }

        /* Gaya Tombol */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        button:hover {
            background-color: var(--secondary-color);
        }
        button.secondary {
            background-color: #f44336;
        }
        button.secondary:hover {
            background-color: #d32f2f;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .btn-group button {
            flex: 1;
            margin-top: 0;
        }

        /* Gaya Input */
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background: var(--background-color);
            color: var(--text-color);
        }
        
        .guess-inputs {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 20px 0;
        }
        .guess-inputs input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5em;
            padding: 0;
        }

        /* Gaya Feedback */
        #feedbackArea {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .num-btn {
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .num-btn:hover {
            background-color: var(--secondary-color);
        }

        /* Gaya Riwayat */
        .history {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--input-border);
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .history div {
            padding: 5px 0;
            border-bottom: 1px dashed var(--input-border);
            display: flex;
            justify-content: space-between;
        }
        .history div:last-child {
            border-bottom: none;
        }

        /* Gaya Overlay Tunggu & Loading */
        #waitOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: none; /* Default: Sembunyi */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            border-radius: 12px;
        }
        #waitOverlay.active {
            display: flex;
        }
        #waitOverlay .message {
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        /* Gaya Kode Room */
        .room-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFC107;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .room-code:hover {
            text-decoration: underline;
        }

        /* Gaya Meja Rahasia */
        .secret-table {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 15px 0;
        }
        .secret-table div {
            width: 40px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border: 2px solid var(--primary-color);
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Setting Toggle */
        .settings {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(16px);
        }

        /* Lightbox */
        #lightbox {
            display: none;
            position: fixed;
            z-index: 1001;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
        }
        #lightboxImg {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
        }
        #lightbox .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
    </style>
</head>
<body>

<audio id="bgMusic" loop>
    <source src="your-background-music.mp3" type="audio/mpeg"> 
</audio>

<div class="settings">
    <div class="toggle-switch" title="Mode Gelap">
        <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
        <span class="slider"></span>
    </div>
    <div class="toggle-switch" title="Musik Latar">
        <input type="checkbox" id="musicToggle" onclick="toggleMusic()">
        <span class="slider"></span>
    </div>
</div>

<div class="container">
    
    <div id="welcome" class="screen active">
        <h2>Selamat Datang di Tebak Angka</h2>
        <p>Tujuanmu: Tebak 4 angka unik rahasia lawan!</p>
        <button onclick="show('modeSelect')">Mulai</button>
    </div>

    <div id="modeSelect" class="screen">
        <h2>Pilih Mode Permainan</h2>
        <button onclick="show('botSetup')">VS Komputer</button>
        <button onclick="show('multiplayerSetup')">Multiplayer (Mabar)</button>
    </div>

    <div id="botSetup" class="screen">
        <h2>Setup VS Komputer</h2>
        <label for="name_bot">Nama Anda:</label>
        <input type="text" id="name_bot" placeholder="Masukkan nama Anda">
        
        <label for="secret_bot">Angka Rahasia (4 angka unik):</label>
        <input type="number" id="secret_bot" placeholder="1234">

        <button onclick="startGame(false)">Mulai Game</button>
        <button class="secondary" onclick="show('modeSelect')">Kembali</button>
    </div>

    <div id="multiplayerSetup" class="screen">
        <h2>Setup Multiplayer</h2>
        <div class="btn-group">
            <button onclick="generateRoom()">Buat Room (Host)</button>
            <button onclick="show('joinRoom')">Gabung Room (Join)</button>
        </div>
        <button class="secondary" onclick="show('modeSelect')">Kembali</button>
    </div>

    <div id="joinRoom" class="screen">
        <h2>Gabung Room</h2>
        <label for="joinRoomInput">Kode Room 4 Angka:</label>
        <input type="text" id="joinRoomInput" placeholder="ABCD" maxlength="4" oninput="this.value = this.value.toUpperCase()">
        <button onclick="showNameSecretSetup('join')">Cari Room</button>
        <button class="secondary" onclick="show('multiplayerSetup')">Kembali</button>
    </div>

    <div id="mabarNameSecret" class="screen">
        <h2>Setup Angka Rahasia Mabar</h2>
        <label for="name_mabar">Nama Anda:</label>
        <input type="text" id="name_mabar" placeholder="Masukkan nama Anda">
        
        <label for="secret_mabar">Angka Rahasia (4 angka unik):</label>
        <input type="number" id="secret_mabar" placeholder="1234">

        <button id="mabarStartGameBtn" onclick="startMultiplayerGame()">Lanjutkan Setup</button>
        <button class="secondary" onclick="cleanupAndShow('multiplayerSetup')">Batalkan</button>
    </div>

    <div id="waitScreen" class="screen">
        <h2>Menunggu Pemain...</h2>
        <p id="waitMessage" style="text-align: center; font-size: 1.1em;"></p>
        <button id="cancelWaitBtn" class="secondary" onclick="cleanupAndShow('multiplayerSetup')">Batalkan dan Kembali</button>
    </div>

    <div id="playerTurn" class="screen">
        <h2 id="turnHeader">Tebak Angka Lawan üéØ</h2>
        <p id="playerNameDisplay" style="font-weight: bold;"></p>

        <div class="secret-table" id="playerSecretTable"></div>

        <p id="result" style="font-style: italic;"></p>

        <div class="guess-inputs">
            <input type="number" id="g1" maxlength="1" oninput="if(this.value.length>this.maxLength) this.value=this.value.slice(0,this.maxLength)">
            <input type="number" id="g2" maxlength="1" oninput="if(this.value.length>this.maxLength) this.value=this.value.slice(0,this.maxLength)">
            <input type="number" id="g3" maxlength="1" oninput="if(this.value.length>this.maxLength) this.value=this.value.slice(0,this.maxLength)">
            <input type="number" id="g4" maxlength="1" oninput="if(this.value.length>this.maxLength) this.value=this.value.slice(0,this.maxLength)">
        </div>
        
        <div style="text-align: center;">
            <button id="guessBtn" onclick="submitGuess()">Kirim Tebakan</button>
            <button id="doneBtn" onclick="afterOpponentFeedback()" style="display: none;">Sudah (Lanjut)</button>
        </div>

        <h3 id="playerHistHeader">Riwayat Tebakanmu:</h3>
        <div class="history" id="playerHistory"></div>
        
        <div class="btn-group">
            <button onclick="show('historyScreen')">Lihat Riwayat Lawan</button>
            <button class="secondary" onclick="confirmSurrender()">Menyerah üè≥Ô∏è</button>
        </div>

        <div id="waitOverlay">
            <p class="message">Menunggu giliranmu...</p>
            <div class="loader">Loading...</div>
            <p id="typingStatusDisplay" style="font-style: italic; font-size: 0.9em; margin-top: 10px;"></p>
            <button onclick="updateOverlay()" style="background: none; border: 1px solid white; color: white;">Refresh Status</button>
        </div>
    </div>

    <div id="botTurn" class="screen">
        <h2 id="opponentTurnHeader">Giliran Lawan üîÆ</h2>
        <p>Tebakan lawan: <span id="botGuess" style="font-weight: bold;"></span></p>

        <p id="feedbackPrompt">Beri tahu lawan berapa angka yang benar:</p>

        <div id="feedbackArea">
            </div>

        <div style="text-align: center;">
            <button id="nextTurnBtn" onclick="nextTurn()" style="display: none;">Giliran Saya (Bot)</button>
        </div>

        <h3 id="opponentHistHeader">Riwayat Tebakan Lawan:</h3>
        <div class="history" id="botHistory"></div>

        <button onclick="show('playerTurn')">Kembali ke Giliranmu</button>
    </div>

    <div id="historyScreen" class="screen">
        <h2>Riwayat Tebakan Lawan</h2>
        <div class="history" id="botHistory"></div>
        <button onclick="show('playerTurn')">Kembali</button>
    </div>

    <div id="cheatScreen" class="screen">
        <h2>üö® Peringatan! Kecurangan Terdeteksi! üö®</h2>
        <p>Feedback yang Anda berikan tidak konsisten dengan angka rahasia Anda. Harap jujur dalam bermain.</p>
        <button class="secondary" onclick="forgiveCheat()">Oke, saya akan jujur</button>
    </div>

    <div id="surrenderScreen" class="screen">
        <h2>Konfirmasi Menyerah</h2>
        <p>Apakah Anda yakin ingin menyerah? Ini akan mengakhiri permainan dan lawan Anda akan menang.</p>
        <div class="btn-group">
            <button class="secondary" onclick="giveUp()">Ya, Saya Menyerah</button>
            <button onclick="cancelSurrender()">Tidak, Lanjutkan Bermain</button>
        </div>
    </div>

    <div id="endScreen" class="screen">
        <h2 id="endMessage">Hasil Permainan</h2>
        <button onclick="cleanupAndShow('welcome')">Main Lagi</button>
    </div>

    <div id="errorScreen" class="screen">
        <h2>‚ö†Ô∏è Terjadi Kesalahan</h2>
        <p id="errorMsg"></p>
        <button onclick="closeError()">Tutup</button>
    </div>
</div>

<div id="lightbox" onclick="this.style.display='none'">
    <span class="close">&times;</span>
    <img id="lightboxImg" alt="Gambar Aturan">
</div>


<script>
// ==========================================================
// INI BAGIAN JAVASCRIPT YANG SUDAH DIPERBAIKI KRITIS
// ==========================================================
/* ===== Script game & switch (Perubahan pada fungsi MABAR dan Listener) ===== */
function openLightbox(img){document.getElementById('lightboxImg').src=img.src;document.getElementById('lightbox').style.display='flex';}
function toggleDarkMode(){document.body.classList.toggle("dark");}
function toggleMusic(){
    const audio=document.getElementById("bgMusic");document.getElementById("musicToggle").checked ? audio.play() : audio.pause();}

// Inisialisasi Firebase (Ganti dengan config Anda yang sebenarnya)
const firebaseConfig = {
    apiKey: "AIzaSyCqgr3gYyc4oFg69xphOWPctvzgCisyL-I",
    authDomain: "game-tebak-angka-2025.firebaseapp.com",
    databaseURL: "https://game-tebak-angka-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "game-tebak-angka-2025",
    storageBucket: "game-tebak-angka-2025.firebasestorage.app",
    messagingSenderId: "776244941517",
    appId: "1:776244941517:web:d9655d10c9532391084f84",
    measurementId: "G-S6NMHPNG7K"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const analytics = firebase.analytics();


/* Generate semua kombinasi 4 angka unik */
const all = [];
(function gen() {
    const d = ['1','2','3','4','5','6','7','8','9'];
    function back(c) {
        if(c.length === 4){ all.push(c.join('')); return; }
        for(const x of d) if(!c.includes(x)){ c.push(x); back(c); c.pop(); }
    }
    back([]);
})();

let playerSecret = "", botSecret = "", possible = [...all], botLast = "";
let playerName = "", isMultiplayer = false, roomCode = "", playerID = null;
let roomData = null; // Data room dari Firebase
let hostWaitListenerRef = null; // Referensi Listener Host Tunggu

const playerHist = document.getElementById('playerHistory');
const botHist = document.getElementById('botHistory');

function isValid(s){ return /^[1-9]{4}$/.test(s) && new Set(s).size===4; }
function match(a,b){ let c=0; for(let i=0;i<4;i++) if(a[i]===b[i]) c++; return c; }
function show(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function error(msg){ document.getElementById('errorMsg').textContent=msg; show('errorScreen'); }
function closeError(){ 
    if(isMultiplayer) { 
        if (roomData && roomData.status === 'playing') showTurnScreen(roomData.turn === playerID);
        else if (roomData && (roomData.status === 'waiting_join' || roomData.status === 'ready_to_start')) show('waitScreen');
        else show('multiplayerSetup');
    } else if (playerSecret) {
        show('playerTurn');
    } else {
        show('welcome'); 
    }
}
function cleanupAndShow(id) {
    cleanupRoom();
    show(id);
}

function setupSecretTable(secret, elementId) {
    const tbl = document.getElementById(elementId);
    tbl.innerHTML = "";
    for(let ch of secret){ const cell=document.createElement('div'); cell.textContent=ch; tbl.appendChild(cell); }
}

// ==========================================================
// LOGIKA GAME UMUM (Bot dan Mabar)
// ==========================================================

function startGame(isMabar) {
    isMultiplayer = isMabar;
    let n, sec;

    if (!isMabar) {
        n = document.getElementById('name_bot').value.trim();
        sec = document.getElementById('secret_bot').value.trim();
    } else {
        n = document.getElementById('name_mabar').value.trim();
        sec = document.getElementById('secret_mabar').value.trim();
    }

    if(!n) return error("Nama tidak boleh kosong!");
    if(!isValid(sec)) return error("Angka rahasia harus 4 angka unik (1‚Äì9, tanpa 0)!");
    
    playerName = n; 
    playerSecret = sec;
    document.getElementById('playerNameDisplay').textContent = (isMabar ? `[${roomCode}] ` : "") + "üë§ " + playerName;
    playerHist.innerHTML = "";
    botHist.innerHTML = "";
    setupSecretTable(playerSecret, 'playerSecretTable');


    if (!isMabar) {
        // Setup VS BOT
        botSecret = all[Math.floor(Math.random()*all.length)];
        possible = [...all]; // Reset possible guesses for bot
        document.getElementById('turnHeader').textContent = "Tebak Angka Bot üéØ";
        document.getElementById('opponentTurnHeader').textContent = "Giliran Bot üîÆ";
        document.getElementById('feedbackPrompt').textContent = "Beri tahu bot berapa angka yang benar:";
        document.getElementById('playerHistHeader').textContent = "Riwayat Tebakanmu:";
        document.getElementById('opponentHistHeader').textContent = "Riwayat Tebakan Bot:";
        show('playerTurn'); g1.focus();
    } else {
        // Setup MULTIPLAYER
        if (playerID === 1) {
            const updates = {
                status: 'playing', 
                player1_name: playerName,
                player1_secret: playerSecret,
            };
            updateRoomData(updates);
            setupMultiplayerListeners(); 
        } else {
            setupMultiplayerListeners();
        }
    }
}

function submitGuess() {
    const g1 = document.getElementById('g1').value;
    const g2 = document.getElementById('g2').value;
    const g3 = document.getElementById('g3').value;
    const g4 = document.getElementById('g4').value;
    const g = [g1,g2,g3,g4].join('');

    if(!isValid(g)) {
        // Pastikan status mengetik di-reset jika validasi gagal
        setTypingStatus(false); 
        return error("Tebakan harus 4 angka unik (1‚Äì9, tanpa 0)!");
    }
    
    let targetSecret = isMultiplayer ? roomData.opponentSecret : botSecret;
    const m = match(g, targetSecret);

    document.getElementById('result').textContent = `Hasil: ${m}`;
    // Riwayat akan di-update oleh listener Firebase di mode Mabar
    if (!isMultiplayer) playerHist.innerHTML += `<div><span>${g}</span> ‚Üí ${m}</div>`; 
    
    document.getElementById('guessBtn').style.display = 'none';
    setTypingStatus(false); // **PENTING: Matikan status typing setelah submit berhasil**

    if(m === 4){ 
        end("Kamu menang! üéâ", true); 
        if(isMultiplayer) updateRoomData({winner: playerName, status: 'ended'});
        return; 
    }

    if (isMultiplayer) {
        // Kirim tebakan ke lawan (Firebase)
        updateRoomData({
            turn: roomData.opponentID, 
            lastGuess: g,
            state: 'feedback_needed', 
            history: [...(roomData.history || []), {guesser: playerName, guess: g, result: null}], 
        });
        updateOverlay();
    } else {
        // VS BOT
        document.getElementById('doneBtn').style.display = 'inline-block';
    }
}

function afterOpponentFeedback(){ 
    // Dipanggil setelah klik 'Sudah' di VS BOT
    document.getElementById('doneBtn').style.display='none'; 
    clearGuess(); 
    showOpponentTurn(); 
}

function showOpponentTurn() {
    if (!isMultiplayer) {
        // Giliran BOT
        botLast = possible[Math.floor(Math.random()*possible.length)];
        document.getElementById('botGuess').textContent = botLast;
        const fb = document.getElementById('feedbackArea'); fb.innerHTML = '';
        document.getElementById('nextTurnBtn').style.display='none';
        for(let i=0;i<=4;i++){
            const b=document.createElement('div');
            b.className='num-btn';
            b.textContent=i;
            b.onclick=()=>feedback(i);
            fb.appendChild(b);
        }
        show('botTurn');
    } else {
        // Giliran LAWAN (Mabar) - Dipicu oleh listener Firebase (State: feedback_needed)
        document.getElementById('opponentTurnHeader').textContent = `Giliran ${roomData.opponentName} üîÆ`;
        document.getElementById('feedbackPrompt').textContent = `Beri tahu ${roomData.opponentName} berapa angka yang benar:`;
        
        if (!roomData.lastGuess) return showWaitScreen(`Menunggu ${roomData.opponentName} mengirim tebakan...`);

        document.getElementById('botGuess').textContent = roomData.lastGuess;
        const fb = document.getElementById('feedbackArea'); fb.innerHTML = '';
        document.getElementById('nextTurnBtn').style.display='none';

        for(let i=0;i<=4;i++){
            const b=document.createElement('div');
            b.className='num-btn';
            b.textContent=i;
            b.onclick=()=>feedback(i, roomData.lastGuess);
            fb.appendChild(b);
        }
        show('botTurn');
        setupFeedbackButtonListeners(); 
        updateOverlay();
    }
}

function feedback(f, guess = botLast){
    const realMatch = match(guess, playerSecret);

    if(f !== realMatch){ 
        setTypingStatus(false); // Matikan status mengetik sebelum ke cheat screen
        show('cheatScreen'); 
        return; 
    }

    setTypingStatus(false); // **PENTING: Matikan status typing setelah feedback berhasil**

    if (!isMultiplayer) {
        // VS BOT
        const filtered = possible.filter(x=>match(x, botLast)===f);
        botHist.innerHTML += `<div><span>${botLast}</span> ‚Üí ${f}</div>`;
        if(f===4){ end("Bot menang! ü§ñ", false); return; }
        possible = filtered;
        document.getElementById('nextTurnBtn').style.display='inline-block';
    } else {
        // MULTIPLAYER
        if(f===4){ 
            end(`${roomData.opponentName} menang! ü§ñ`, false); 
            updateRoomData({winner: roomData.opponentName, status: 'ended'});
            return; 
        }

        // Update history lawan (guesser) dengan hasil feedback
        const history = roomData.history;
        const lastIndex = history.length - 1;
        history[lastIndex].result = f; // Update hasil tebakan lawan

        // Kirim feedback ke lawan (Firebase)
        updateRoomData({
            turn: roomData.opponentID, 
            lastFeedback: f,
            state: 'guess_received', 
            history: history, 
        });
        showWaitScreen(`Feedback terkirim. Menunggu ${roomData.opponentName} menebak kembali...`); 
    }
}

function nextTurn() {
    document.getElementById('nextTurnBtn').style.display='none';
    showTurnScreen(true);
}

function clearGuess() {
    const inputs = [g1, g2, g3, g4];
    inputs.forEach(input => input.value = '');
    g1.focus();
}

function end(msg, isWin) {
    document.getElementById('endMessage').textContent = msg;
    show('endScreen');
    // Hapus listener Mabar setelah game berakhir
    if (isMultiplayer && roomCode) {
        db.ref('rooms/' + roomCode).off('value');
    }
}

function confirmSurrender() { show('surrenderScreen'); }
function cancelSurrender() { show('playerTurn'); }
function giveUp() {
    if (isMultiplayer) {
        // Mabar: Kirim sinyal menyerah ke Firebase
        updateRoomData({
            status: 'ended', 
            winner: roomData.opponentName,
            disconnection: playerName
        });
    }
    end("Anda menyerah. Lawan Anda menang.", false);
}

function forgiveCheat() { 
    // Kembali ke Giliran Lawan (Feedback)
    showOpponentTurn(); 
}

/* Auto-pindah fokus saat input tebakan */
const g1 = document.getElementById('g1');
const g2 = document.getElementById('g2');
const g3 = document.getElementById('g3');
const g4 = document.getElementById('g4');
const guessInputs = [g1,g2,g3,g4];
guessInputs.forEach((input, idx)=>{
    input.addEventListener('input', ()=>{
        if(input.value.length===1 && idx<guessInputs.length-1){ 
            guessInputs[idx+1].focus(); 
        }
    });
    // Tambahkan listener keydown untuk 'Enter' di input terakhir
    if (idx === guessInputs.length - 1) {
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('guessBtn').click();
            }
        });
    }
});


// ==========================================================
// LOGIKA MULTIPLAYER (MABAR)
// ==========================================================

let mode = ""; // 'host' atau 'join'

function generateRoomCode() {
    return Math.random().toString(36).substring(2, 6).toUpperCase();
}

function generateRoom() {
    roomCode = generateRoomCode();
    sessionStorage.setItem('currentRoomCode', roomCode); 
    playerID = 1; 
    mode = 'host';
    db.ref('rooms/' + roomCode).off('value'); 

    // Set initial room data
    db.ref('rooms/' + roomCode).set({
        status: 'waiting_join',
        turn: 1, 
        state: 'setup',
        history: [],
        player1_name: "Host",
        player2_name: "Tamu",
        player1_typing: false,
        player2_typing: false,
        lastGuess: null,
        lastFeedback: null,
    }).then(() => {
        showWaitScreen("Menunggu pemain lain bergabung..."); 
        document.getElementById('cancelWaitBtn').textContent = "Batalkan dan Kembali";
        
        // **PERBAIKAN SINKRONISASI HOST (TIDAK DOUBLE KLIK):** // Ganti tombol cancel dengan tombol Lanjut jika P2 sudah siap
        document.getElementById('waitMessage').innerHTML = `Room dibuat. Kode Room:<br><div class="room-code" onclick="copyCode('${roomCode}')">${roomCode}</div>(klik untuk salin)<br><span id="hostWaitStatus">Menunggu lawan...</span>`;

        // Tambahkan listener untuk menunggu P2
        const ref = db.ref('rooms/' + roomCode);
        // Pastikan listener sebelumnya dimatikan
        if (hostWaitListenerRef) ref.off('value', hostWaitListenerRef); 
        hostWaitListenerRef = (snapshot) => hostWaitingListener(snapshot, ref);
        ref.on('value', hostWaitListenerRef);
    }).catch(e => error("Gagal membuat room: " + e.message));
}

function hostWaitingListener(snapshot, ref) {
    roomData = snapshot.val();
    if (!roomData) return;
    
    if (roomData.status === 'ready_to_start' && mode === 'host') {
        // P2 sudah bergabung dan siap
        document.getElementById('hostWaitStatus').textContent = `${roomData.player2_name || "Lawan"} sudah siap! ‚úÖ`;
        // **Perubahan: Tombol Cancel menjadi Lanjutkan Setup**
        document.getElementById('cancelWaitBtn').textContent = `Lanjutkan Setup vs ${roomData.player2_name || "Lawan"} ‚ñ∂Ô∏è`;
        document.getElementById('cancelWaitBtn').onclick = () => {
            ref.off('value', hostWaitListenerRef); // Matikan listener tunggu
            showNameSecretSetup('host'); // Lanjut ke setup nama/angka Host
        };
    } else if (roomData.status === 'ended') {
        ref.off('value', hostWaitListenerRef); // Matikan listener
        end("Lawan terputus atau menyerah.", false); 
    }
}

function copyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        alert('Kode Room disalin: ' + code);
    });
}

function showNameSecretSetup(m) {
    mode = m;
    document.getElementById('name_mabar').value = "";
    document.getElementById('secret_mabar').value = "";

    if (mode === 'join') {
        roomCode = document.getElementById('joinRoomInput').value.trim().toUpperCase();
        if (roomCode.length !== 4) return error("Kode room harus 4 karakter.");
        
        db.ref('rooms/' + roomCode).once('value').then(snapshot => {
            roomData = snapshot.val();
            if (!roomData || roomData.status === 'ended' || roomData.status === 'playing' || roomData.status === 'ready_to_start') return error("Room tidak ditemukan, sudah penuh, atau sudah dimulai!");

            playerID = 2; // Gabung selalu P2
            sessionStorage.setItem('currentRoomCode', roomCode);
            document.getElementById('mabarStartGameBtn').textContent = "Gabung Game ‚ñ∂Ô∏è";
            show('mabarNameSecret');
        }).catch(e => {
            error("Gagal koneksi ke server: " + e.message);
        });
    } else {
        // Host - Lanjut dari layar tunggu
        if (!roomCode) return error("Harap generate room code terlebih dahulu!");
        show('mabarNameSecret');
    }
}

function startMultiplayerGame() {
    playerName = document.getElementById('name_mabar').value.trim();
    playerSecret = document.getElementById('secret_mabar').value.trim();
    
    if(!playerName) return error("Nama tidak boleh kosong!");
    if(!isValid(playerSecret)) return error("Angka rahasia harus 4 angka unik (1‚Äì9, tanpa 0)!");

    if (mode === 'join') {
        // P2 update status, nama, dan secret
        updateRoomData({
            status: 'ready_to_start',
            player2_name: playerName,
            player2_secret: playerSecret,
        });
        
        showWaitScreen(`Menunggu Host (${roomData.player1_name}) memulai game...`);
        document.getElementById('cancelWaitBtn').textContent = "Batalkan Koneksi";
        
        // Listener di P2 untuk menunggu Host Start
        db.ref('rooms/' + roomCode).on('value', joinWaitingListener);

    } else if (mode === 'host') {
        // Host (P1)
        if(roomData.status !== 'ready_to_start') return error("Room masih menunggu pemain lain bergabung!");
        
        // P1 update nama dan secret, lalu start game
        updateRoomData({
            status: 'playing',
            player1_name: playerName,
            player1_secret: playerSecret,
        });
        // Langsung masuk ke game
        setupRoomContext();
        startGame(true);
    }
}

function joinWaitingListener(snapshot) {
    roomData = snapshot.val();
    if (!roomData) return end("Koneksi terputus.", false);
    
    if (roomData.status === 'playing') {
        db.ref('rooms/' + roomCode).off('value', joinWaitingListener);
        setupRoomContext();
        startGame(true); // Mulai game!
    } else if (roomData.status === 'ended') {
        db.ref('rooms/' + roomCode).off('value', joinWaitingListener);
        end("Host membatalkan atau koneksi terputus.", false);
    }
}

function setupRoomContext() {
    // Pastikan roomData sudah terisi
    if (!roomData) return; 

    if (playerID === 1) {
        roomData.opponentName = roomData.player2_name;
        roomData.opponentSecret = roomData.player2_secret;
        roomData.opponentID = 2;
    } else if (playerID === 2) {
        roomData.opponentName = roomData.player1_name;
        roomData.opponentSecret = roomData.player1_secret;
        roomData.opponentID = 1;
    }
    
    document.getElementById('playerNameDisplay').textContent = `[${roomCode}] üë§ ${playerName}`;
    document.getElementById('turnHeader').textContent = `Tebak Angka ${roomData.opponentName} üéØ`;
    document.getElementById('playerHistHeader').textContent = `Riwayat Tebakanmu (${playerName}):`;
    document.getElementById('opponentTurnHeader').textContent = `Giliran ${roomData.opponentName} üîÆ`;
    document.getElementById('opponentHistHeader').textContent = `Riwayat Tebakan ${roomData.opponentName}:`;
}


function showWaitScreen(message) {
    document.getElementById('waitMessage').textContent = message;
    // Atur ulang tombol cancel jika tidak ada logika khusus
    if (mode !== 'host' || !roomData || roomData.status !== 'ready_to_start') {
        document.getElementById('cancelWaitBtn').textContent = "Batalkan dan Kembali";
        document.getElementById('cancelWaitBtn').onclick = () => cleanupAndShow('multiplayerSetup');
    }
    show('waitScreen');
}

// Fungsi untuk update data di Firebase
function updateRoomData(updates) {
    db.ref('rooms/' + roomCode).update(updates).catch(e => {
        error("Gagal update data room: " + e.message);
    });
}

// Menentukan tampilan giliranmu atau giliran lawan
function showTurnScreen(isMyTurn) {
    setupSecretTable(playerSecret, 'playerSecretTable');

    if (isMyTurn) {
        document.getElementById('guessBtn').style.display='inline-block';
        document.getElementById('doneBtn').style.display='none';
        clearGuess(); g1.focus();
        show('playerTurn');
        setupGuessInputListeners(); 
        updateOverlay(); 
    } else {
        show('playerTurn'); 
        updateOverlay(); 
    }
}

// Sinkronisasi status mengetik
function setTypingStatus(isTyping, isFeedback = false) {
    if (!isMultiplayer || !roomCode || !roomData || roomData.status !== 'playing') return;
    const key = `player${playerID}_typing`;
    const value = isTyping ? (isFeedback ? 'feedback' : 'guess') : false;
    db.ref('rooms/' + roomCode + '/' + key).set(value);
}

function setupGuessInputListeners() {
    const inputs = [g1, g2, g3, g4];
    inputs.forEach(input => {
        input.onfocus = () => setTypingStatus(true, false);
        // **PERBAIKAN KRITIS: Hapus onblur yang mengganggu saat submit**
        input.onblur = () => { /* Logika onblur dihapus untuk menghindari race condition saat submit */ };
    });
    
    // Matikan status mengetik jika input terakhir kosong
    g4.onblur = () => { if (g4.value.length === 0) setTypingStatus(false); };
    
    // Pastikan status dimatikan saat tombol submit diklik, sebelum submitGuess dipanggil
    const guessBtn = document.getElementById('guessBtn');
    guessBtn.onclick = null; 
    guessBtn.onclick = submitGuess;
}

function setupFeedbackButtonListeners() {
    const buttons = document.getElementById('feedbackArea').querySelectorAll('.num-btn');
    buttons.forEach(button => {
        // Bersihkan listener lama
        button.onclick = null;
        button.onfocus = null;
        button.onblur = null;

        // Feedback tombol diklik berarti selesai
        button.onclick = (e) => { 
            // setTypingStatus(false) dipanggil di dalam fungsi feedback
            feedback(parseInt(e.target.textContent), roomData.lastGuess); 
        };
        
        // Tambahkan listener untuk status mengetik
        button.onfocus = () => setTypingStatus(true, true);
        button.onblur = () => setTypingStatus(false);
    });
}

function updateHistoryDisplay(history) {
    playerHist.innerHTML = "";
    botHist.innerHTML = "";
    
    if (!history) return;

    history.forEach(item => {
        if (!item.guess) return;

        const guesser = item.guesser;
        const guess = item.guess;
        const result = item.result !== null ? item.result : '...';

        const html = `<div><span>${guess}</span> ‚Üí ${result}</div>`;

        if (guesser === playerName) {
            playerHist.innerHTML += html;
        } else {
            botHist.innerHTML += html;
        }
    });
}

function updateOverlay() {
    const overlay = document.getElementById('waitOverlay');
    const statusDisplay = document.getElementById('typingStatusDisplay');

    if (!isMultiplayer || roomData.status !== 'playing') {
        overlay.classList.remove('active');
        return;
    }

    const isMyTurn = roomData.turn === playerID;

    if (isMyTurn) {
        // Jika giliranmu, overlay harus mati kecuali lawan sedang melakukan sesuatu
        if (roomData.opponentTyping === 'guess' || roomData.opponentTyping === 'feedback') {
            overlay.classList.add('active');
            overlay.querySelector('.message').textContent = `${roomData.opponentName} sedang mengetik...`;
            statusDisplay.textContent = "";
        } else if (roomData.state === 'feedback_needed' && !isMyTurn) {
             // Ini harusnya tidak terjadi, tapi sebagai jaga-jaga
        } else {
            overlay.classList.remove('active');
        }
    } else {
        // Jika giliran lawan, selalu aktifkan overlay pada layar playerTurn
        if (currentScreenId === 'playerTurn') {
            overlay.classList.add('active');
            let message = "Menunggu giliranmu...";

            if (roomData.opponentTyping === 'guess') {
                message = `${roomData.opponentName} sedang menebak...`;
            } else if (roomData.opponentTyping === 'feedback') {
                message = `${roomData.opponentName} sedang memberikan feedback...`;
            } else if (roomData.state === 'feedback_needed') {
                 message = `Giliranmu memberikan feedback ke ${roomData.opponentName}!`;
            }

            overlay.querySelector('.message').textContent = message;
            statusDisplay.textContent = ""; 
        } else {
            overlay.classList.remove('active');
        }
    }
}


// Listener utama untuk sinkronisasi Mabar
function setupMultiplayerListeners() {
    // Hapus listener lama jika ada
    db.ref('rooms/' + roomCode).off('value');

    db.ref('rooms/' + roomCode).on('value', snapshot => {
        const data = snapshot.val();
        if (!data || data.status === 'setup' || data.status === 'waiting_join' || data.status === 'ready_to_start') return; 

        roomData = {
            ...data,
            opponentID: playerID === 1 ? 2 : 1,
            opponentName: playerID === 1 ? data.player2_name : data.player1_name,
            opponentSecret: playerID === 1 ? data.player2_secret : data.player1_secret,
            opponentTyping: playerID === 1 ? data.player2_typing : data.player1_typing,
        }

        setupRoomContext(); 

        // 1. Cek Game Ended
        if (data.status === 'ended') {
            if (data.winner === playerName) end("Kamu menang! üéâ", true);
            else if (data.winner) end(`${data.winner} menang! ü§ñ`, false);
            else end("Permainan berakhir.", false); 
            return;
        }

        // 2. Update Riwayat Tebakan
        updateHistoryDisplay(data.history);

        // 3. Logika Giliran
        const isMyTurn = data.turn === playerID;

        if (isMyTurn) {
            if (data.state === 'feedback_needed') {
                // Lawan baru saja menebak, giliranmu memberi feedback
                showOpponentTurn();
            } else if (data.state === 'guess_received' || data.state === 'playing') {
                // Lawan sudah memberi feedback, giliranmu menebak
                if (data.lastFeedback !== undefined && data.lastFeedback !== null) {
                    // Tampilkan hasil tebakanmu sebelumnya
                    document.getElementById('result').textContent = `Hasil tebakanmu: ${data.lastFeedback}`;
                    
                    // Reset state setelah jeda 1.5 detik
                    setTimeout(() => {
                        updateRoomData({state: 'playing', lastFeedback: null, lastGuess: null});
                        showTurnScreen(true); 
                    }, 1500); 
                } else {
                    // Pindah giliran menebak tanpa jeda jika tidak ada feedback baru
                    showTurnScreen(true); 
                }
            }
        } else {
            // Giliran Lawan
            // Pindah ke layar tebakanmu dengan overlay tunggu aktif
            show('playerTurn');
            updateOverlay(); 
        }
    });
}


let currentScreenId = 'welcome';
const originalShow = show;
show = function(id) {
    originalShow(id);
    currentScreenId = id;
    if(isMultiplayer && roomData && roomData.status === 'playing') updateOverlay();
}


// Cleanup function: hapus room jika Host keluar
function cleanupRoom() {
    if (!roomCode) return;
    
    // Matikan semua listener
    db.ref('rooms/' + roomCode).off('value');
    if (hostWaitListenerRef) { // Matikan listener tunggu Host
        db.ref('rooms/' + roomCode).off('value', hostWaitListenerRef);
        hostWaitListenerRef = null;
    }

    // Logika penghapusan room
    if (isMultiplayer && playerID === 1 && roomData && roomData.status !== 'ended') {
        // Host menghapus room saat keluar
        db.ref('rooms/' + roomCode).remove().catch(e => console.error("Gagal menghapus room: ", e));
    } else if (isMultiplayer && playerID === 2 && roomData && roomData.status !== 'ended') {
        // P2 mengirim sinyal 'disconnection'
        db.ref('rooms/' + roomCode).update({
            status: 'ended', 
            winner: roomData.player1_name || "Host",
            disconnection: roomData.player2_name || "Pemain 2"
        });
    }
    
    isMultiplayer = false;
    roomCode = "";
    playerID = null;
    roomData = null;
    sessionStorage.removeItem('currentRoomCode');
}
window.onbeforeunload = cleanupRoom;

</script>

</body>
</html>
