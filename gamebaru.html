<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tebak 4 Angka â€” vs Bot & Mabar</title>
<style>
/* ===== CSS utama ===== */
body { font-family: "Poppins", sans-serif; background: linear-gradient(135deg, #ffe6f0, #ffd7e5); display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
.screen { 
    display: none; 
    text-align: center; 
    background: #fff; 
    padding: 24px; 
    border-radius: 16px; 
    box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
    width: 380px; 
    max-height: 90vh; 
    overflow-y: auto; 
    /* PERBAIKAN KRITIS: Ini memastikan Overlay berfungsi */
    position: relative; 
}
.active { display: block; }
h1 { color: #b30057; font-size: 24px; margin-bottom: 12px; }
input[type=text] { text-align: center; width: 80%; font-size: 20px; padding: 10px; margin: 8px; border: 2px solid #ffcce0; border-radius: 10px; }
button { background: #ff7aa2; color: white; border: none; border-radius: 8px; padding: 10px 18px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: 0.2s; }
button:hover { background: #ff5d8a; transform: scale(1.05); }
.num-btn { width: 50px; height: 50px; border-radius: 8px; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; border: 1px solid #eee; cursor: pointer; margin: 6px; background: #fff0f5; color: #b30057; transition: all .2s; }
.num-btn:hover { background: #ffd6e8; transform: scale(1.1); }
.table-secret { display: flex; justify-content: center; gap: 8px; margin: 10px 0 20px; }
.table-secret div { background: #d2b48c; color: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; border-radius: 6px; font-weight: 700; }
.bot-box { background: linear-gradient(135deg, #ffccd5, #d2b48c); color: #5a2c2c; border-radius: 10px; padding: 20px; font-size: 26px; font-weight: 800; width: 160px; margin: 12px auto; }
.history { background: #fff6f9; border-radius: 10px; padding: 10px; margin-top: 12px; text-align: left; max-height: 180px; overflow-y: auto; font-size: 14px; line-height: 1.6; }
.history span { color: #b30057; font-weight: 600; }
.rules { text-align: left; background: #fff0f5; border-radius: 10px; padding: 12px 16px; margin-top: 14px; font-size: 14px; color: #5a2c2c; }
.guess-grid { display: flex; justify-content: center; gap: 8px; margin: 12px 0; }
.guess-grid input { width: 50px; height: 50px; border-radius: 10px; font-size: 22px; font-weight: bold; border: 2px solid #ffb6c1; color: #b30057; text-align: center; }
#playerNameDisplay { position: absolute; top: 12px; left: 12px; color: #b30057; font-weight: 700; font-size: 14px; }
.surrender-btn { position: absolute; top: 10px; right: 14px; background: #ff5d8a; color: white; border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
#endScreen img, #cheatScreen img, #surrenderScreen img { width: 160px; height: 160px; border-radius: 50%; margin: 16px 0; object-fit: cover; border: 4px solid #ff7aa2; cursor: pointer; transition: 0.3s; }
.verse { margin-top: 12px; background: #fff0f5; border-radius: 10px; padding: 10px; color: #5a2c2c; font-size: 13px; font-style: italic; }
#endDetails, #cheatDetails, #surrenderDetails { background: #fff0f5; border-radius: 10px; padding: 10px; color: #5a2c2c; font-weight: 600; margin-top: 8px; }
#errorScreen { background: #8b0000; color: #fff; text-align: center; }
.btn-row { display: flex; justify-content: center; gap: 10px; margin-top: 14px; }
.multiplayer-block { background: #fff0f5; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
.room-code { font-size: 28px; font-weight: bold; color: #b30057; margin: 10px 0; padding: 10px; border: 2px dashed #ffcce0; border-radius: 8px; display: inline-block; cursor: pointer; }
.join-input { width: 70%; padding: 10px; font-size: 18px; border: 2px solid #ffcce0; border-radius: 10px; text-align: center; margin-bottom: 10px; }

/* Waiting screen styles */
#waitScreen { background: linear-gradient(135deg, #e6f0ff, #d7e5ff); color: #0057b3; }
#waitScreen h1 { color: #0057b3; }
.spinner { border: 8px solid #f3f3f3; border-top: 8px solid #b30057; border-radius: 50%; width: 50px; height: 50px; animation: spin 1.5s linear infinite; margin: 20px auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.wait-text { font-size: 18px; font-weight: 600; margin-top: 10px; }

/* Overlay Blur/Loading (Mabar) - Sesuai permintaan */
#mabarWaitOverlay, #mabarWaitOverlayBot {
position: absolute;
top: 0; left: 0; right: 0; bottom: 0;
background: rgba(255, 255, 255, 0.9);
backdrop-filter: blur(2px); /* <-- EFEK BLUR */
    -webkit-backdrop-filter: blur(2px); /* Kompatibilitas browser */
z-index: 10;
display: none;
align-items: center;
justify-content: center;
flex-direction: column;
border-radius: 16px;
color: #b30057;
font-weight: bold;
}
#mabarWaitOverlay .spinner, #mabarWaitOverlayBot .spinner {
border-top: 8px solid #b30057; width:              30px; height: 30px; margin-bottom:10px;
}

/* Switch pojok kanan atas - Sesuai permintaan */
#topSwitches {
position:fixed;
top: 12px;
right: 12px; /* Pindah ke kanan */
left: auto;
display: flex;
gap: 12px; 
z-index: 1000;
}
.switch { position: relative; display: inline-block; width: 60px; height: 28px; }
.switch input { display: none; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ffb6c1; border-radius: 34px; transition: 0.3s; }
.slider:before { position: absolute; content: "ğŸŒ™"; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.3s; }
input:checked + .slider { background-color: #b30057; }
input:checked + .slider:before { transform: translateX(32px); content: "â˜€ï¸"; }
.slider.music { background-color: #ffd1dc; }
.slider.music:before { content: "ğŸµ"; }
input:checked + .slider.music:before { content: "ğŸ”Š"; }

/* Mode gelap */
body.dark { background: linear-gradient(135deg, #2b002b, #4a004a); color: #f8d8e8; }
body.dark .screen { background: #3a003a; color: #f8d8e8; box-shadow: 0 6px 15px rgba(0,0,0,0.4); }
body.dark button { background: #a34a78; color: white; }
body.dark button:hover { background: #c15a8f; }
body.dark .history { background: #4a004a; color: #fbd7e8; }
body.dark .rules { background: #4a004a; color: #ffe6f0; }
body.dark .multiplayer-block { background: #4a004a; }
body.dark .room-code { color: #f8d8e8; border: 2px dashed #a34a78; }
body.dark #mabarWaitOverlay, body.dark #mabarWaitOverlayBot { background: rgba(0, 0, 0, 0.8); color: #ff7aa2; }
body.dark .guess-grid input { border: 2px solid #a34a78; background: #4a004a; color: #f8d8e8; }
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
</head>
<body onbeforeunload="cleanupRoom()">

<div id="topSwitches">
Â  <label class="switch">
Â  Â  <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
Â  Â  <span class="slider"></span>
Â  </label>
Â  <label class="switch">
Â  Â  <input type="checkbox" id="musicToggle" onchange="toggleMusic()">
Â  Â  <span class="slider music"></span>
Â  </label>
</div>

<audio id="bgMusic" src="Kasih Putih (Acoustic).mp3" loop></audio>

<div id="playerNameDisplay"></div>

<div id="welcome" class="screen active">
Â  <h1>ğŸ® Selamat Datang di Game Tebak 4 Angka ğŸ€</h1>
Â  <p>Pilih mode permainan:</p>
Â  <div class="btn-row" style="flex-direction:column; gap:15px;">
Â  Â  <div style="background: #fff0f5; padding: 20px; border-radius: 10px;">
Â  Â  Â  <h3>Melawan Bot ğŸ¤–</h3>
Â  Â  Â  <input id="name_bot" type="text" placeholder="Nama Pemain"><br>
Â  Â  Â  <input id="secret_bot" type="text" maxlength="4" placeholder="Angka Kamu"><br>
Â  Â  Â  <button onclick="handleStartGame(false)">Mulai Game (vs Bot) â–¶ï¸</button>
Â  Â  </div>
Â  Â  <button onclick="show('multiplayerSetup')">Mabar (Multiplayer) ğŸ‘¯</button>
Â  </div>
Â  <div class="btn-row">
Â  Â  <button onclick="showHistoryScreen()">ğŸ“œ Riwayat</button>
Â  </div>
Â  <div class="rules">
Â  Â  <h2>ğŸ“œ Peraturan & Petunjuk:</h2>
Â  Â  <ul>
Â  Â  Â  <li>Gunakan angka <b>1â€“9</b> (tidak boleh 0 dan tidak boleh ganda).</li>
Â  Â  Â  <li>Pemain dan lawan bergantian menebak angka satu sama lain.</li>
Â  Â  </ul>
Â  </div>
</div>

<div id="multiplayerSetup" class="screen">
Â  <h1>ğŸ‘¯ Mabar (Multiplayer)</h1>
Â  <p>Pilih mode koneksi:</p>
Â Â 
Â  Â  <div class="multiplayer-block">
Â  Â  <h3>ğŸ”‘ Buat Room Baru (Host)</h3>
Â  Â  <p id="hostRoomCodeDisplay">Tekan tombol untuk membuat kode.</p>
Â  Â  <button id="generateRoomBtn" onclick="generateRoom()">Generate Room</button>
Â  </div>
Â Â 
Â  ---
Â Â 
Â  Â  <div class="multiplayer-block">
Â  Â  <h3>ğŸšª Gabung Room</h3>
Â  Â  <input id="joinRoomInput" type="text" class="join-input" maxlength="4" placeholder="Masukkan Kode Party"><br>
Â  Â  <button onclick="showNameSecretSetup('join')">Gabung Room â–¶ï¸</button>
Â  </div>
Â Â 
Â  <button onclick="cleanupAndShow('welcome')">â¬…ï¸ Kembali</button>
</div>

<div id="mabarNameSecret" class="screen">
Â  <h1>ğŸ® Siap Mabar!</h1>
Â  <p>Masukkan namamu dan angka rahasiamu:</p>
Â  <input id="name_mabar" type="text" placeholder="Nama Pemain"><br>
Â  <input id="secret_mabar" type="text" maxlength="4" placeholder="Angka Kamu"><br>
Â  Â  <button id="mabarStartGameBtn" onclick="startMultiplayerSetup()">Lanjutkan â–¶ï¸</button>Â 
Â  <button onclick="cleanupAndShow('multiplayerSetup')">â¬…ï¸ Kembali</button>
</div>

<div id="waitScreen" class="screen">
Â  <h1>â³ Tunggu Lawan</h1>
Â  <div class="spinner"></div>
Â  <p class="wait-text" id="waitMessage">Menunggu pemain lain bergabung...</p>
Â  <button id="cancelWaitBtn" onclick="cleanupAndShow('multiplayerSetup')">Batalkan dan Kembali</button>
</div>

<div id="playerTurn" class="screen">
Â  Â  <div id="mabarWaitOverlay">
Â  Â  Â  Â  <div class="spinner"></div>
Â  Â  Â  Â  <p id="playerWaitText">Menunggu lawan...</p>
Â  Â  </div>
Â  <div class="surrender-btn" onclick="confirmSurrender()">ğŸ³ï¸ Menyerah</div>
Â  <h1 id="turnHeader">Tebak Angka Lawan ğŸ¯</h1>
Â  <div class="guess-grid">
Â  Â  <input id="g1" maxlength="1">
Â  Â  <input id="g2" maxlength="1">
Â  Â  <input id="g3" maxlength="1">
Â  Â  <input id="g4" maxlength="1">
Â  </div>
Â  <button id="guessBtn" onclick="submitGuess()">Kirim Tebakan</button>
Â  <p id="result"></p>
Â  <button id="doneBtn" style="display:none;" onclick="afterOpponentFeedback()">Lanjutkan â–¶ï¸</button>
Â  <h3 id="playerHistHeader">Riwayat Tebakanmu:</h3>
Â  <div class="history" id="playerHistory"></div>
</div>

<div id="botTurn" class="screen" style="background:linear-gradient(135deg,#ffe6f0,#d2b48c);">
Â  Â  <div id="mabarWaitOverlayBot">
Â  Â  Â  Â  <div class="spinner"></div>
Â  Â  Â  Â  <p id="botWaitText">Menunggu lawan...</p>
Â  Â  </div>
Â  <div class="surrender-btn" onclick="confirmSurrender()">ğŸ³ï¸ Menyerah</div>
Â  <h1 id="opponentTurnHeader">Giliran Lawan ğŸ”®</h1>
Â  <p>Angka rahasiamu:</p>
Â  <div id="playerSecretTable" class="table-secret"></div>
Â  <div class="bot-box" id="botGuess">----</div>
Â  <p id="feedbackPrompt">Beri tahu lawan berapa angka yang benar:</p>
Â  <div id="feedbackArea"></div>
Â  <button id="nextTurnBtn" style="display:none;" onclick="nextTurn()">Selesai âœ…</button>
Â  <h3 id="opponentHistHeader">Riwayat Tebakan Lawan:</h3>
Â  <div class="history" id="botHistory"></div>
</div>

<div id="cheatScreen" class="screen">
Â  <img src="IMG-20251006-WA0031.jpg" alt="Jangan Curang">
Â  <h1>ğŸš« Jangan Curang!</h1>
Â  <div id="cheatDetails">
Â  Â  <p>Kamu memberi feedback yang salah... ğŸ˜”<br>Ingatlah untuk bermain jujur ya!</p>
Â  </div>
Â  <div class="verse">ğŸ’¡ â€œHendaklah integritasmu nyata di setiap hal kecil.â€</div>
Â  <button onclick="forgiveCheat()">ğŸ™ Saya Bertobat</button>
</div>

<div id="surrenderScreen" class="screen">
Â  <img src="IMG-20251016-WA0019.jpg" alt="Menyerah">
Â  <h1>ğŸ˜¢ Yakin nih mau nyerah?</h1>
Â  <div id="surrenderDetails">
Â  Â  <p>Kalau menyerah, kamu langsung dinyatakan kalah loh!</p>
Â  </div>
Â  <div class="verse">ğŸ“– <b>Filipi 4:13</b> â€” â€œSegala perkara dapat kutanggung di dalam Dia yang memberi kekuatan kepadaku.â€</div>
Â  <div class="btn-row">
Â  Â  <button onclick="cancelSurrender()">Tidak ğŸ˜¤</button>
Â  Â  <button onclick="giveUp()">Iya ğŸ˜”</button>
Â  Â  </div>
</div>

<div id="endScreen" class="screen">
Â  <img id="endImg" src="" alt="Foto Akhir">
Â  <h1 id="endMsg"></h1>
Â  <div id="endDetails"></div>
Â  <div id="endVerse" class="verse"></div>
Â  <button onclick="location.reload()">Main Lagi ğŸ”</button>
</div>

<div id="errorScreen" class="screen">
Â  <h1 id="errorMsg"></h1>
Â  <button onclick="closeError()">Baiklah ğŸ˜…</button>
</div>

<script>
// ==========================================================
// 1. UTILITY & CONFIGURATION
// ==========================================================
function toggleDarkMode(){document.body.classList.toggle("dark");}
function toggleMusic(){
Â  const audio=document.getElementById("bgMusic");
Â  document.getElementById("musicToggle").checked ? audio.play() : audio.pause();
}

// GANTI DENGAN KONFIGURASI FIREBASE ANDA
const firebaseConfig = {
Â  apiKey: "AIzaSyCqgr3gYyc4oFg69xphOWPctvzgCisyL-I",
Â  authDomain: "game-tebak-angka-2025.firebaseapp.com",
Â  databaseURL: "https://game-tebak-angka-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
Â  projectId: "game-tebak-angka-2025",
Â  storageBucket: "game-tebak-angka-2025.firebasestorage.app",
Â  messagingSenderId: "776244941517",
Â  appId: "1:776244941517:web:d9655d10c9532391084f84",
Â  measurementId: "G-S6NMHPNG7K"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
// const analytics = firebase.analytics(); // Di-disable untuk menghindari error jika belum diinisialisasi di HTML

// Cache DOM elements
const g1 = document.getElementById('g1'), g2 = document.getElementById('g2'), g3 = document.getElementById('g3'), g4 = document.getElementById('g4');
const guessInputs = [g1,g2,g3,g4];
const playerHist = document.getElementById('playerHistory');
const botHist = document.getElementById('botHistory');

// Game State Variables
let playerSecret = "", botSecret = "", possible = [], botLast = "";
let playerName = "", isMultiplayer = false, roomCode = "", playerID = null;
let roomData = null; 
let currentScreenId = 'welcome';
let mode = ""; // 'host' atau 'join'

// Generate semua kombinasi 4 angka unik (1-9, non-ganda)
const all = [];
(function gen() {
Â  const d = ['1','2','3','4','5','6','7','8','9'];
Â  function back(c) {
Â  Â  if(c.length === 4){ all.push(c.join('')); return; }
Â  Â  for(const x of d) if(!c.includes(x)){ c.push(x); back(c); c.pop(); }
Â  }
Â  back([]);
Â  possible = [...all]; // Inisialisasi awal
})();

// Helper Functions
function isValid(s){ return /^[1-9]{4}$/.test(s) && new Set(s).size===4; }
function match(a,b){ let c=0; for(let i=0;i<4;i++) if(a[i]===b[i]) c++; return c; }
function error(msg){ document.getElementById('errorMsg').textContent=msg; show('errorScreen'); }

function show(id){ 
Â  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); 
Â  document.getElementById(id).classList.add('active'); 
Â  currentScreenId = id; // Update screen ID
Â  if(isMultiplayer && roomData && roomData.status === 'playing') updateOverlay();
}

function closeError(){Â 
Â  // Coba kembali ke layar game/setup yang sesuai
Â  if(isMultiplayer) {Â 
Â  Â  if (roomData && roomData.status === 'playing') showTurnScreen(roomData.turn === playerID);
Â  Â  else if (roomData && (roomData.status === 'waiting_join' || roomData.status === 'ready_to_start')) show('waitScreen');
Â  Â  else show('multiplayerSetup');
Â  } else if (playerSecret) {
Â  Â  show('playerTurn');
Â  } else {
Â  Â  show('welcome');Â 
Â  }
}
function cleanupAndShow(id) { cleanupRoom(); show(id); }
function copyCode(code) { navigator.clipboard.writeText(code).then(() => alert('Kode Room disalin: ' + code)); }

function setupSecretTable(secret, elementId) {
Â  const tbl = document.getElementById(elementId);
Â  tbl.innerHTML = "";
Â  for(let ch of secret){ const cell=document.createElement('div'); cell.textContent=ch; tbl.appendChild(cell); }
}

guessInputs.forEach((input, idx)=>{
Â  input.addEventListener('input', ()=>{
Â  Â  if(input.value.length===1 && idx<guessInputs.length-1){ guessInputs[idx+1].focus(); }
Â  });
});


// ==========================================================
// 2. GAME LOGIC (Bot & Mabar)
// ==========================================================

function handleStartGame(isMabar) {
Â  isMultiplayer = isMabar;
Â  const nameInput = isMabar ? document.getElementById('name_mabar') : document.getElementById('name_bot');
Â  const secretInput = isMabar ? document.getElementById('secret_mabar') : document.getElementById('secret_bot');

Â  playerName = nameInput.value.trim();
Â  playerSecret = secretInput.value.trim();

Â  if(!playerName) return error("Nama tidak boleh kosong!");
Â  if(!isValid(playerSecret)) return error("Angka rahasia harus 4 angka unik (1â€“9, tanpa 0)!");

Â  document.getElementById('playerNameDisplay').textContent = (isMabar ? `[${roomCode}] ` : "") + "ğŸ‘¤ " + playerName;
Â  playerHist.innerHTML = "";
Â  botHist.innerHTML = "";
Â  setupSecretTable(playerSecret, 'playerSecretTable');

Â  if (!isMabar) {
Â  Â  // VS BOT Setup
Â  Â  botSecret = all[Math.floor(Math.random()*all.length)];
Â  Â  possible = [...all]; 
Â  Â  document.getElementById('turnHeader').textContent = "Tebak Angka Bot ğŸ¯";
Â  Â  document.getElementById('opponentTurnHeader').textContent = "Giliran Bot ğŸ”®";
Â  Â  document.getElementById('feedbackPrompt').textContent = "Beri tahu bot berapa angka yang benar:";
Â  Â  show('playerTurn'); setupGuessInputListeners(true); g1.focus();
Â  } else {
Â  Â  // MULTIPLAYER Setup (P1/P2)
Â  Â  setupRoomContext(); // Update opponent data
Â  Â  setupMultiplayerListeners(); // Mulai dengarkan update dari lawan

Â  Â  if (playerID === 1) {
Â  Â  Â  // Host (P1) memulai state game
Â  Â  Â  updateRoomData({
Â  Â  Â  Â  status: 'playing', turn: 1, state: 'playing', 
Â  Â  Â  Â  player1_name: playerName, player1_secret: playerSecret,
Â  Â  Â  });
Â  Â  Â  showTurnScreen(true); // P1 mulai menebak
Â  Â  } else {
Â  Â  Â  // Joiner (P2) sudah update secret di startMultiplayerSetup. Tunggu P1 memulai turn
Â  Â  Â  showWaitScreen(`Menunggu Host (${roomData.player1_name}) memulai giliran pertama...`);
Â  Â  }
Â  }
}

function submitGuess() {
Â  const g = [g1.value,g2.value,g3.value,g4.value].join('');
Â  if(!isValid(g)) return error("Tebakan harus 4 angka unik (1â€“9, tanpa 0)!");
Â Â 
Â  const targetSecret = isMultiplayer ? roomData.opponentSecret : botSecret;
Â  const m = match(g, targetSecret);

Â  document.getElementById('result').textContent = `Hasil: ${m}`;
Â  setTypingStatus(false); // Matikan status typing

Â  if(m === 4){Â 
Â  Â  end("Kamu menang! ğŸ‰", true);Â 
Â  Â  if(isMultiplayer) updateRoomData({winner: playerName, status: 'ended'});
Â  Â  return;Â 
Â  }

Â  if (isMultiplayer) {
Â  Â  // Kirim tebakan ke lawan (Firebase)
Â  Â  updateRoomData({
Â  Â  Â  turn: roomData.opponentID, 
Â  Â  Â  lastGuess: g,
Â  Â  Â  state: 'feedback_needed', // Lawan harus beri feedback
Â  Â  Â  [`player${playerID}_typing`]: false,
Â  Â  Â  history: [...(roomData.history || []), {guesser: playerName, guess: g, result: null}],Â 
Â  Â  });
Â  Â  showTurnScreen(false); // Langsung ke layar tunggu
Â  } else {
Â  Â  // VS BOT
Â  Â  playerHist.innerHTML += `<div><span>${g}</span> â†’ ${m}</div>`;
Â  Â  document.getElementById('guessBtn').style.display = 'none';
Â  Â  document.getElementById('doneBtn').style.display = 'inline-block';
Â  }
}

function afterOpponentFeedback(){Â 
Â  // Dipanggil setelah klik 'Lanjutkan' di VS BOT
Â  document.getElementById('doneBtn').style.display='none';Â 
Â  clearGuess();Â 
Â  showOpponentTurn();Â 
}

function showOpponentTurn() {
Â  setupSecretTable(playerSecret, 'playerSecretTable'); 
Â  const fb = document.getElementById('feedbackArea'); fb.innerHTML = '';
Â  document.getElementById('nextTurnBtn').style.display='none';
Â  const currentGuess = isMultiplayer ? roomData.lastGuess : botLast;
Â 
Â  if (!isMultiplayer) {
Â  Â  // Giliran BOT
Â  Â  botLast = possible[Math.floor(Math.random()*possible.length)];
Â  Â  document.getElementById('botGuess').textContent = botLast;
Â  } else {
Â  Â  // Giliran LAWAN (Mabar) - Memberi feedback
Â  Â  if (!currentGuess || roomData.state !== 'feedback_needed') {
Â  Â  Â  return showWaitScreen(`Menunggu ${roomData.opponentName} mengirim tebakan...`);
Â  Â  }
Â  Â  document.getElementById('opponentTurnHeader').textContent = `Giliran ${roomData.opponentName} ğŸ”®`;
Â  Â  document.getElementById('feedbackPrompt').textContent = `Beri tahu ${roomData.opponentName} berapa angka yang benar:`;
Â  Â  document.getElementById('botGuess').textContent = currentGuess;
Â  }

Â  for(let i=0;i<=4;i++){
Â  Â  const b=document.createElement('div');
Â  Â  b.className='num-btn';
Â  Â  b.textContent=i;
Â  Â  b.onclick=()=>feedback(i, currentGuess);
Â  Â  fb.appendChild(b);
Â  }
Â  show('botTurn');
Â  if (isMultiplayer) setupFeedbackButtonListeners(); 
}

function feedback(f, guess){
Â  const realMatch = match(guess, playerSecret);

Â  if(f !== realMatch){ 
Â  Â  setTypingStatus(false, false); 
Â  Â  return show('cheatScreen'); 
Â  }

Â  setTypingStatus(false, false);

Â  if (!isMultiplayer) {
Â  Â  // VS BOT
Â  Â  const filtered = possible.filter(x=>match(x, botLast)===f);
Â  Â  botHist.innerHTML += `<div><span>${botLast}</span> â†’ ${f}</div>`;
Â  Â  if(f===4){ end("Bot menang! ğŸ¤–", false); return; }
Â  Â  possible = filtered;
Â  Â  document.getElementById('nextTurnBtn').style.display='inline-block';
Â  } else {
Â  Â  // MULTIPLAYER
Â  Â  if(f===4){Â 
Â  Â  Â  end(`${roomData.opponentName} menang! ğŸ¤–`, false);Â 
Â  Â  Â  updateRoomData({winner: roomData.opponentName, status: 'ended'});
Â  Â  Â  return;Â 
Â  Â  }

Â  Â  const history = roomData.history;
Â  Â  const lastIndex = history.length - 1;
Â  Â  history[lastIndex].result = f; 

Â  Â  // Kirim feedback ke lawan (Firebase)
Â  Â  updateRoomData({
Â  Â  Â  turn: roomData.opponentID, // Pindah giliran ke lawan (yang menebak tadi)
Â  Â  Â  lastFeedback: f,
Â  Â  Â  state: 'guess_received', 
Â  Â  Â  history: history, 
Â  Â  });
Â  Â  showTurnScreen(false); // Kembali ke layar tebakanmu sambil menunggu
Â  }
}

function forgiveCheat(){Â 
Â  if (isMultiplayer) { updateRoomData({state: 'feedback_needed'}); showOpponentTurn(); } 
Â  else { show('botTurn'); }
}
function confirmSurrender(){ show('surrenderScreen'); }
function cancelSurrender(){ show(currentScreenId); }
function giveUp(){Â 
Â  end("Kamu menyerah ğŸ˜”", false);Â 
Â  if(isMultiplayer) updateRoomData({winner: roomData.opponentName, status: 'ended'});
Â  cleanupRoom();
}
function nextTurn(){ show('playerTurn'); document.getElementById('guessBtn').style.display='inline-block'; clearGuess(); setupGuessInputListeners(true); g1.focus(); }
function clearGuess(){ g1.value=g2.value=g3.value=g4.value=''; document.getElementById('result').textContent=''; }

function end(msg, win){
Â  const img=document.getElementById('endImg');
Â  // Ganti dengan path gambar Anda yang sesuai
Â  img.src=win?"IMG-20251016-WA0037.jpg":"motion_photo_7499955795629952970.jpg"; 
Â  document.getElementById('endMsg').textContent=msg;
Â  const p2 = isMultiplayer ? (roomData.opponentName || "Lawan") : "Bot";
Â  document.getElementById('endDetails').innerHTML=`<p>ğŸ”¢ Angka ${playerName}: <b>${playerSecret}</b><br>ğŸ”¢ Angka ${p2}: <b>${isMultiplayer ? roomData.opponentSecret : botSecret}</b></p>`;
Â  document.getElementById('endVerse').innerHTML = win
Â  Â  ? "ğŸ“– <b>Roma 8:37</b> â€” 'Tetapi dalam semuanya itu kita lebih dari pada orang-orang yang menang, oleh Dia yang telah mengasihi kita.'"
Â  Â  : "ğŸ“– <b>Yeremia 29:11</b> â€” 'Sebab Aku ini mengetahui rancangan-rancangan apa yang ada pada-Ku mengenai kamu, demikianlah firman TUHAN, yaitu rancangan damai sejahtera dan bukan rancangan kecelakaan.'";
Â Â 
Â  db.ref('rooms/' + roomCode).off('value'); 
Â  show('endScreen');
}

function showHistoryScreen(){
Â  const list = document.getElementById('historyList');
Â  list.innerHTML = "";
Â  // (Logika menampilkan riwayat di sini, sudah aman dari versi sebelumnya)
Â  show('historyScreen');
}


// ==========================================================
// 3. MULTIPLAYER LOGIC (Mabar)
// ==========================================================

function generateRoom() {
Â  roomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
Â  playerID = 1; 
Â  mode = 'host';
Â  db.ref('rooms/' + roomCode).off('value'); 

Â  db.ref('rooms/' + roomCode).set({
Â  Â  status: 'waiting_join', turn: 1, state: 'setup', history: [],
Â  Â  player1_name: "Host", player2_name: "Tamu",
Â  Â  player1_typing: false, player2_typing: false,
Â  Â  lastGuess: null, lastFeedback: null,
Â  Â  created_at: firebase.database.ServerValue.TIMESTAMP
Â  }).then(() => {
Â  Â  showWaitScreen(`Room dibuat. Kode Room:<br><div class="room-code" onclick="copyCode('${roomCode}')">${roomCode}</div>(klik untuk salin)<br><span id="hostWaitStatus">Menunggu lawan...</span>`);
Â  Â  db.ref('rooms/' + roomCode).on('value', hostWaitingListener);
Â  }).catch(e => error("Gagal membuat room: " + e.message));
}

function hostWaitingListener(snapshot) {
Â  roomData = snapshot.val();
Â  if (!roomData || mode !== 'host') return;
Â 
Â  if (roomData.status === 'ready_to_start') {
Â  Â  document.getElementById('hostWaitStatus').textContent = `${roomData.player2_name || "Lawan"} sudah siap! âœ…`;
Â  Â  db.ref('rooms/' + roomCode).off('value', hostWaitingListener); 
Â  Â  document.getElementById('cancelWaitBtn').textContent = `Lanjutkan Setup vs ${roomData.player2_name || "Lawan"} â–¶ï¸`;
Â  Â  document.getElementById('cancelWaitBtn').onclick = () => showNameSecretSetup('host');
Â  } else if (roomData.status === 'ended') {
Â  Â  db.ref('rooms/' + roomCode).off('value', hostWaitingListener);
Â  Â  end("Lawan terputus.", false);
Â  }
}

function showNameSecretSetup(m) {
Â  mode = m;
Â  document.getElementById('name_mabar').value = "";
Â  document.getElementById('secret_mabar').value = "";
Â  db.ref('rooms/' + roomCode).off('value', hostWaitingListener); 

Â  if (mode === 'join') {
Â  Â  roomCode = document.getElementById('joinRoomInput').value.trim().toUpperCase();
Â  Â  if (roomCode.length !== 4) return error("Kode room harus 4 karakter.");
Â  Â Â 
Â  Â  db.ref('rooms/' + roomCode).once('value').then(snapshot => {
Â  Â  Â  roomData = snapshot.val();
Â  Â  Â  if (!roomData || roomData.status === 'ended') return error("Room tidak ditemukan atau sudah berakhir!");
Â  Â  Â  if (roomData.status !== 'waiting_join') return error("Room sudah penuh atau sudah dimulai!");

Â  Â  Â  playerID = 2; 
Â  Â  Â  document.getElementById('mabarStartGameBtn').textContent = `Gabung Game vs ${roomData.player1_name} â–¶ï¸`;
Â  Â  Â  show('mabarNameSecret');
Â  Â  }).catch(e => error("Gagal koneksi ke server: " + e.message));
Â  } else {
Â  Â  // Host
Â  Â  if (!roomCode) return error("Harap generate room code terlebih dahulu!");
Â  Â  show('mabarNameSecret');
Â  }
}

function startMultiplayerSetup() {
Â  playerName = document.getElementById('name_mabar').value.trim();
Â  playerSecret = document.getElementById('secret_mabar').value.trim();
Â Â 
Â  if(!playerName) return error("Nama tidak boleh kosong!");
Â  if(!isValid(playerSecret)) return error("Angka rahasia harus 4 angka unik (1â€“9, tanpa 0)!");

Â  if (mode === 'join') {
Â  Â  // P2 update status & secret
Â  Â  updateRoomData({
Â  Â  Â  status: 'ready_to_start', 
Â  Â  Â  player2_name: playerName,
Â  Â  Â  player2_secret: playerSecret,
Â  Â  });
Â  Â Â 
Â  Â  showWaitScreen(`Menunggu Host (${roomData.player1_name}) memulai game...`);
Â  Â  db.ref('rooms/' + roomCode).on('value', joinWaitingListener);

Â  } else if (mode === 'host') {
Â  Â  // Host (P1) update nama/secret lalu start game
Â  Â  if(roomData.status !== 'ready_to_start') return error("Room masih menunggu pemain lain bergabung!");
Â  Â  handleStartGame(true);
Â  }
}

function joinWaitingListener(snapshot) {
Â  roomData = snapshot.val();
Â  if (!roomData) return end("Koneksi terputus.", false);
Â  if (roomData.status === 'playing') {
Â  Â  db.ref('rooms/' + roomCode).off('value', joinWaitingListener);
Â  Â  handleStartGame(true); // Mulai game! (P2 akan menunggu turn P1)
Â  } else if (roomData.status === 'ended') {
Â  Â  db.ref('rooms/' + roomCode).off('value', joinWaitingListener);
Â  Â  end("Host membatalkan atau koneksi terputus.", false);
Â  }
}

function setupRoomContext() {
Â  if (!roomData) return; 
Â  const oppID = playerID === 1 ? 2 : 1;
Â  roomData.opponentID = oppID;
Â  roomData.opponentName = roomData[`player${oppID}_name`];
Â  roomData.opponentSecret = roomData[`player${oppID}_secret`];
Â  roomData.opponentTyping = roomData[`player${oppID}_typing`];
Â Â 
Â  document.getElementById('playerNameDisplay').textContent = `[${roomCode}] ğŸ‘¤ ${playerName}`;
Â  document.getElementById('turnHeader').textContent = `Tebak Angka ${roomData.opponentName} ğŸ¯`;
Â  document.getElementById('opponentTurnHeader').textContent = `Giliran ${roomData.opponentName} ğŸ”®`;
}

function showWaitScreen(message) {
Â  document.getElementById('waitMessage').innerHTML = message;
Â  document.getElementById('cancelWaitBtn').textContent = "Batalkan dan Kembali";
Â  document.getElementById('cancelWaitBtn').onclick = () => cleanupAndShow('multiplayerSetup');
Â  show('waitScreen');
}

function updateRoomData(updates) {
Â  db.ref('rooms/' + roomCode).update(updates).catch(e => {
Â  Â  error("Gagal update data room: " + e.message);
Â  });
}

function showTurnScreen(isMyTurn) {
Â  document.getElementById('result').textContent = ""; 
Â  setupSecretTable(playerSecret, 'playerSecretTable');

Â  if (isMyTurn) {
Â  Â  document.getElementById('guessBtn').style.display='inline-block';
Â  Â  document.getElementById('doneBtn').style.display='none';
Â  Â  clearGuess(); setupGuessInputListeners(true); g1.focus(); 
Â  Â  show('playerTurn');
Â  } else {
Â  Â  // Jika bukan giliranmu, pastikan input dinonaktifkan
Â  Â  setupGuessInputListeners(false); 
Â  Â  show('playerTurn');
Â  }
Â  updateOverlay(); // Kontrol overlay (blur/loading)
}

function setTypingStatus(isTyping, isGuessing) {
Â  if (!isMultiplayer || !roomCode || !roomData || roomData.status !== 'playing') return;
Â  const key = `player${playerID}_typing`;
Â  const value = isTyping ? (isGuessing ? 'guess' : 'feedback') : false;
Â  db.ref('rooms/' + roomCode + '/' + key).set(value);
}

function setupGuessInputListeners(isMyTurn) {
Â  guessInputs.forEach(input => {
Â  Â  input.disabled = !isMyTurn;
Â  Â  input.onfocus = isMyTurn ? () => setTypingStatus(true, true) : null;
Â  });
Â  g4.onblur = isMyTurn ? () => { if (g4.value.length < 1) setTypingStatus(false, true); } : null;
Â  document.getElementById('guessBtn').disabled = !isMyTurn;
}

function setupFeedbackButtonListeners() {
Â  const buttons = document.getElementById('feedbackArea').querySelectorAll('.num-btn');
Â  buttons.forEach(button => {
Â  Â  button.onfocus = () => setTypingStatus(true, false);
Â  Â  button.onblur = () => setTypingStatus(false, false);
Â  });
}

function updateHistoryDisplay(history) {
Â  playerHist.innerHTML = "";
Â  botHist.innerHTML = "";
Â  if (!history) return;

Â  history.forEach(item => {
Â  Â  if (!item.guess) return;
Â  Â  const guesser = item.guesser;
Â  Â  const result = item.result !== null ? item.result : '...';
Â  Â  const html = `<div><span>${item.guess}</span> â†’ ${result}</div>`;

Â  Â  if (guesser === playerName) {
Â  Â  Â  playerHist.innerHTML += html;
Â  Â  } else if (guesser === roomData.opponentName) {
Â  Â  Â  botHist.innerHTML += html;
Â  Â  }
Â  });
}

// FUNGSI KRITIKAL: Mengontrol Layar Blur/Loading Mabar
function updateOverlay() {
Â  const playerOverlay = document.getElementById('mabarWaitOverlay');
Â  const botOverlay = document.getElementById('mabarWaitOverlayBot');

Â  // Selalu sembunyikan jika bukan Mabar atau game belum mulai
Â  if (!isMultiplayer || roomData.status !== 'playing') {
Â  Â  playerOverlay.style.display = 'none';
Â  Â  botOverlay.style.display = 'none';
Â  Â  return;
Â  }

Â  const isMyTurn = roomData.turn === playerID;
Â  const oppTyping = roomData.opponentTyping; 

Â  if (currentScreenId === 'playerTurn') {
Â  Â  // Muncul jika BUKAN giliranmu (menunggu lawan menebak/feedback) 
Â  Â  // ATAU jika giliranmu tapi lawan sedang mengetik (menunggu input lawan selesai)
Â  Â  if (!isMyTurn || oppTyping) {
Â  Â  Â  playerOverlay.style.display = 'flex';
Â  Â  Â  let message = "Menunggu giliranmu...";
Â  Â  Â  if (oppTyping === 'guess') {
Â  Â  Â  Â  message = `${roomData.opponentName} sedang menebak...`;
Â  Â  Â  } else if (oppTyping === 'feedback') {
Â  Â  Â  Â  message = `${roomData.opponentName} sedang memberikan feedback...`;
Â  Â  Â  }
Â  Â  Â  document.getElementById('playerWaitText').textContent = message;
Â  Â  } else {
Â  Â  Â  playerOverlay.style.display = 'none';
Â  Â  }
Â  } else if (currentScreenId === 'botTurn') {
Â  Â  // Hanya aktif jika kamu sedang memberi feedback (turnmu)
Â  Â  if (roomData.state === 'feedback_needed') {
        // Overlay di botTurn seharusnya TIDAK muncul karena kamu harus memberi feedback
        botOverlay.style.display = 'none';
    } else {
        // Jika turn lawan dan sedang menunggu dia menebak/feedback
        botOverlay.style.display = 'flex';
        let message = "Menunggu giliran lawan...";
        if (oppTyping === 'guess') {
            message = `${roomData.opponentName} sedang menebak...`;
        } else if (oppTyping === 'feedback') {
            message = `${roomData.opponentName} sedang memberikan feedback...`;
        }
        document.getElementById('botWaitText').textContent = message;
    }
Â  } else {
Â  Â  playerOverlay.style.display = 'none';
Â  Â  botOverlay.style.display = 'none';
Â  }
}


function setupMultiplayerListeners() {
Â  db.ref('rooms/' + roomCode).off('value');

Â  db.ref('rooms/' + roomCode).on('value', snapshot => {
Â  Â  const data = snapshot.val();
Â  Â  if (!data || data.status === 'setup' || data.status === 'waiting_join' || data.status === 'ready_to_start') return; 

Â  Â  roomData = { ...data, opponentID: playerID === 1 ? 2 : 1 };
Â  Â  setupRoomContext(); // Refetch opponent data dan typing status

Â  Â  if (data.status === 'ended') {
Â  Â  Â  if (data.winner === playerName) end("Kamu menang! ğŸ‰", true);
Â  Â  Â  else if (data.winner) end(`${data.winner} menang! ğŸ¤–`, false);
Â  Â  Â  else end("Permainan berakhir (terputus).", false); 
Â  Â  Â  return;
Â  Â  }

Â  Â  updateHistoryDisplay(data.history);

Â  Â  const isMyTurn = data.turn === playerID;

Â  Â  if (data.state === 'feedback_needed' && !isMyTurn) {
Â  Â  Â  // Jika lawan baru menebak, dan giliranmu memberi feedback (feedback_needed + turn lawan)
Â  Â  Â  showOpponentTurn();
Â  Â  } else if (data.state === 'guess_received' && isMyTurn) {
Â  Â  Â  // Giliranmu menebak dan feedback sudah diterima
Â  Â  Â  if (data.lastFeedback !== undefined && data.lastFeedback !== null) {
Â  Â  Â  Â  document.getElementById('result').textContent = `Hasil tebakanmu: ${data.lastFeedback}`;
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  updateRoomData({state: 'playing', lastFeedback: null, lastGuess: null});
Â  Â  Â  Â  Â  showTurnScreen(true); 
Â  Â  Â  Â  }, 1500); 
Â  Â  Â  }
Â  Â  } else if (data.state === 'playing' && isMyTurn) {
Â  Â  Â  // Giliranmu menebak
Â  Â  Â  showTurnScreen(true); 
Â  Â  } else if (data.state === 'playing' && !isMyTurn) {
Â  Â  Â  // Giliran lawan, kamu menunggu
Â  Â  Â  showTurnScreen(false);
Â  Â  }
Â  });
}


function cleanupRoom() {
Â  if (!roomCode) return;
Â 
Â  db.ref('rooms/' + roomCode).off('value');

Â  if (isMultiplayer && roomData && roomData.status !== 'ended') {
Â  Â  if (playerID === 1 && (roomData.status === 'waiting_join' || roomData.status === 'ready_to_start')) {
Â  Â  Â  // Host yang keluar sebelum game/saat tunggu
Â  Â  Â  db.ref('rooms/' + roomCode).remove();
Â  Â  } else if (roomData.status === 'playing') {
Â  Â  Â  // Pemain di tengah game mengirim sinyal kalah/putus
Â  Â  Â  const winner = playerID === 1 ? roomData.player2_name : roomData.player1_name;
Â  Â  Â  db.ref('rooms/' + roomCode).update({
Â  Â  Â  Â  status: 'ended', 
Â  Â  Â  Â  winner: winner,
Â  Â  Â  Â  disconnection: playerName
Â  Â  Â  });
Â  Â  }
Â  }
Â 
Â  isMultiplayer = false;
Â  roomCode = "";
Â  playerID = null;
Â  roomData = null;
}
</script>

</body>
</html>
