<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tebak 4 Angka — vs Bot & Mabar</title>
<style>
/* ===== CSS utama (pink lembut) ===== */
:root{
  --bg1:#ffe6f0; --bg2:#ffd7e5; --accent:#b30057; --card:#fff; --muted:#5a2c2c;
}
body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, var(--bg1), var(--bg2));
  display: flex; align-items: center; justify-content: center;
  height: 100vh; margin: 0;
}
.screen { display: none; text-align: center; background: var(--card);
  padding: 24px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  width: 380px; max-height: 90vh; overflow-y: auto; position: relative;
}
.active { display: block; }
h1 { color: var(--accent); font-size: 24px; margin-bottom: 12px; }
input[type=text] { text-align: center; width: 80%; font-size: 20px; padding: 10px;
  margin: 8px; border: 2px solid #ffcce0; border-radius: 10px;
}
button { background: #ff7aa2; color: white; border: none; border-radius: 8px;
  padding: 10px 18px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transition: 0.2s;
}
button:hover { background: #ff5d8a; transform: scale(1.03); }

.num-btn { width: 50px; height: 50px; border-radius: 8px;
  display: inline-flex; align-items: center; justify-content: center;
  font-weight: 700; border: 1px solid #eee; cursor: pointer;
  margin: 6px; background: #fff0f5; color: var(--accent); transition: all .2s; }
.num-btn:hover { background: #ffd6e8; transform: scale(1.05); }

.table-secret { display: flex; justify-content: center; gap: 8px; margin: 10px 0 20px; }
.table-secret div { background: #d2b48c; color: white; width: 40px; height: 40px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; border-radius: 6px; font-weight: 700; }

.bot-box { background: linear-gradient(135deg, #ffccd5, #d2b48c);
  color: #5a2c2c; border-radius: 10px; padding: 20px;
  font-size: 26px; font-weight: 800; width: 160px; margin: 12px auto; }

.history { background: #fff6f9; border-radius: 10px; padding: 10px; margin-top: 12px;
  text-align: left; max-height: 180px; overflow-y: auto; font-size: 14px; line-height: 1.6; }
.history span { color: var(--accent); font-weight: 600; }
.rules { text-align: left; background: #fff0f5; border-radius: 10px;
  padding: 12px 16px; margin-top: 14px; font-size: 14px; color: var(--muted); }

.guess-grid { display: flex; justify-content: center; gap: 8px; margin: 12px 0; }
.guess-grid input { width: 50px; height: 50px; border-radius: 10px;
  font-size: 22px; font-weight: bold; border: 2px solid #ffb6c1;
  color: var(--accent); text-align: center; }

#playerNameDisplay { position: absolute; top: 12px; left: 12px; color: var(--accent); font-weight: 700; font-size: 14px; }
.surrender-btn { position: absolute; top: 10px; right: 14px;
  background: #ff5d8a; color: white; border-radius: 8px; padding: 6px 10px;
  font-size: 12px; cursor: pointer; }

/* small responsive */
@media (max-width:420px){
  .screen{ width:92%; }
}
</style>
</head>
<body>

<!-- Top info -->
<div id="playerNameDisplay"></div>

<!-- WELCOME -->
<div id="welcome" class="screen active">
  <h1>🎮 Tebak 4 Angka — Main Sendiri / Mabar</h1>
  <p>Masukkan namamu dan angka rahasiamu (1–9, 4 angka unik)</p>
  <input id="name" type="text" placeholder="Nama Pemain"><br>
  <input id="secret" type="text" maxlength="4" placeholder="Angka Rahasiamu"><br>
  <div style="margin-top:8px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
    <button id="btnHistory">📜 Riwayat</button>
    <button id="btnVsBot">🎯 Vs Bot</button>
    <button id="btnMabar">🌐 Mabar (Online)</button>
  </div>
  <div class="rules">
    <h3>Petunjuk singkat</h3>
    <ul>
      <li>Gunakan angka <b>1–9</b>, tidak boleh 0 dan tidak boleh angka berulang.</li>
      <li>Jika tebakan menghasilkan <b>4</b> angka posisi tepat, maka MENANG.</li>
    </ul>
  </div>
</div>

<!-- ONLINE MENU -->
<div id="onlineMenu" class="screen">
  <h1>🌐 Mabar — Buat / Gabung Room</h1>
  <div class="rules">
    <p>Pilih buat room atau gabung ke room teman. Kode room sederhana 5 karakter.</p>
  </div>

  <div style="background:#fff6f9;padding:14px;border-radius:10px;margin-top:10px;">
    <h3>👑 Make Room</h3>
    <div>Kode Room kamu:</div>
    <div id="roomCode" style="font-size:20px;font-weight:700;color:var(--accent);margin:8px 0;">—</div>
    <div style="display:flex;gap:8px;justify-content:center;">
      <button id="btnGen">🔑 Generate</button>
      <button id="btnMakeStart">Start</button>
    </div>
  </div>

  <div style="background:#fff6f9;padding:14px;border-radius:10px;margin-top:12px;">
    <h3>🤝 Join Room</h3>
    <input id="joinCode" maxlength="6" placeholder="Masukkan kode room"><br>
    <div style="margin-top:8px;"><button id="btnJoinStart">Start</button></div>
  </div>

  <div style="margin-top:12px;"><button id="btnBackFromOnline">⬅️ Kembali</button></div>
</div>

<!-- PLAYER TURN (used for vs bot & online when it's your turn) -->
<div id="playerTurn" class="screen">
  <div class="surrender-btn" id="btnSurrender">🏳️ Menyerah</div>
  <h1 id="playerTurnTitle">Giliranmu — Tebak Angka</h1>
  <div class="guess-grid">
    <input id="g1" maxlength="1" inputmode="numeric">
    <input id="g2" maxlength="1" inputmode="numeric">
    <input id="g3" maxlength="1" inputmode="numeric">
    <input id="g4" maxlength="1" inputmode="numeric">
  </div>
  <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
    <button id="guessBtn">Kirim Tebakan</button>
    <button id="clearBtn">Bersihkan</button>
  </div>
  <p id="result"></p>
  <h3>Riwayat Tebakan:</h3>
  <div class="history" id="playerHistory"></div>
  <div style="margin-top:8px;"><button id="btnBackToMenu">🏠 Menu</button></div>
</div>

<!-- WAIT / OPPONENT TURN -->
<div id="opponentTurn" class="screen">
  <div class="surrender-btn" id="btnSurrender2">🏳️ Menyerah</div>
  <h1 id="opponentTitle">Giliran Lawan</h1>
  <p>Angka rahasiamu:</p>
  <div id="playerSecretTable" class="table-secret"></div>
  <div class="bot-box" id="opponentGuess">Menunggu...</div>
  <div style="margin-top:8px;">Tunggu lawan mengirim tebakan...</div>
  <h3>Riwayat Tebakan Lawan:</h3>
  <div class="history" id="opponentHistory"></div>
  <div style="margin-top:8px;"><button id="btnBackToMenu2">🏠 Menu</button></div>
</div>

<!-- END SCREEN -->
<div id="endScreen" class="screen">
  <h1 id="endMsg"></h1>
  <div id="endDetails"></div>
  <div style="margin-top:12px;"><button id="btnPlayAgain">Main Lagi</button></div>
</div>

<script>
/* ===== small DOM helper & game utils ===== */
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));const el=document.getElementById(id);if(el)el.classList.add('active');}
function $(id){return document.getElementById(id);} 
function isValidSecret(s){return /^[1-9]{4}$/.test(s) && new Set(s).size===4}
function match(a,b){let c=0;for(let i=0;i<4;i++) if(a[i]===b[i]) c++; return c}

/* ===== local vs-bot logic (kept simple) ===== */
const allComb=[]; (function(){const d='123456789'.split(''); function back(c){ if(c.length===4){ allComb.push(c.join('')); return } for(const x of d) if(!c.includes(x)){ c.push(x); back(c); c.pop(); } } back([]);})();
let localBotSecret='';

/* Auto-focus inputs */
const guessInputs = ['g1','g2','g3','g4'].map(id=>$(id));
guessInputs.forEach((inp,idx)=>{ inp.addEventListener('input',()=>{ if(inp.value.length===1 && idx<guessInputs.length-1) guessInputs[idx+1].focus(); }); });

/* ===== UI wiring ===== */
$('btnVsBot').addEventListener('click',()=>{show('welcome'); alert('Isi nama + secret di form utama lalu tekan Start Vs Bot pada welcome jika ingin lawan bot.\nUntuk mabar, pilih Mabar.');});
$('btnMabar').addEventListener('click',()=> show('onlineMenu'));
$('btnBackFromOnline').addEventListener('click',()=> show('welcome'));
$('btnBackToMenu').addEventListener('click',()=> show('welcome'));
$('btnBackToMenu2').addEventListener('click',()=> show('welcome'));
$('btnHistory').addEventListener('click',()=>{ show('welcome'); alert('Riwayat sederhana ada di panel permainan nanti.'); });
$('btnPlayAgain').addEventListener('click',()=> location.reload());
$('clearBtn').addEventListener('click',()=>{ guessInputs.forEach(i=>i.value=''); guessInputs[0].focus(); $('result').textContent=''; });

/* ===== Generate / UI helper for room code ===== */
function makeRoomCode(){ return Math.random().toString(36).replace(/[^A-Z0-9]/ig,'').substring(2,7).toUpperCase(); }
window.generateRoomCode = function(){ const code=makeRoomCode(); $('roomCode').textContent=code; sessionStorage.setItem('roomCodeTemp',code); }
$('btnGen').addEventListener('click',()=> window.generateRoomCode());

/* ===== Vs Bot start (simple) ===== */
$('btnVsBot').addEventListener('click',()=>{
  const n = $('name').value.trim(); const sec=$('secret').value.trim();
  if(!n){ alert('Nama tidak boleh kosong'); return; }
  if(!isValidSecret(sec)){ alert('Angka rahasia harus 4 angka unik (1-9)'); return; }
  localBotSecret = allComb[Math.floor(Math.random()*allComb.length)];
  sessionStorage.setItem('localPlayerName', n);
  sessionStorage.setItem('localPlayerSecret', sec);
  $('playerNameDisplay').textContent = '👤 '+n;
  $('playerHistory').innerHTML=''; $('opponentHistory').innerHTML='';
  show('playerTurn'); guessInputs[0].focus();
});

$('guessBtn').addEventListener('click',()=>{
  const g = guessInputs.map(i=>i.value).join('');
  const onlineRoom = sessionStorage.getItem('onlineRoom');
  if(onlineRoom){ // when online, use function that will be defined in module
    if(window.submitGuessOnline){ window.submitGuessOnline(g); clearGuessInputs(); }
    else alert('Fitur online belum siap (module belum dimuat)');
    return;
  }
  if(!/^[1-9]{4}$/.test(g) || new Set(g).size!==4){ alert('Tebakan harus 4 angka unik (1-9)'); return; }
  const res = match(g, localBotSecret);
  $('result').textContent = `Hasil: ${res}`;
  $('playerHistory').innerHTML += `<div><span>${g}</span> → ${res}</div>`;
  if(res===4){ showEnd('Kamu menang! 🎉', true); return; }
  // bot turn simple
  setTimeout(()=>{
    const botGuess = allComb[Math.floor(Math.random()*allComb.length)];
    const botResult = match(botGuess, sessionStorage.getItem('localPlayerSecret'));
    $('opponentHistory').innerHTML += `<div><span>${botGuess}</span> → ${botResult}</div>`;
    if(botResult===4){ showEnd('Bot menang 🤖', false); return; }
    show('playerTurn');
  }, 800);
});
function clearGuessInputs(){ guessInputs.forEach(i=>i.value=''); guessInputs[0].focus(); $('result').textContent=''; }

function showEnd(msg, win){ $('endMsg').textContent = msg; $('endDetails').innerHTML = win?'<p>Selamat!</p>':'<p>Coba lagi ya.</p>'; show('endScreen'); }

/* ===== Firebase module (mabar) - loaded as module below ===== */
// We'll keep placeholders; actual realtime interactions are in module script

</script>

<!-- ===== Firebase module (type=module) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, get, update, onValue, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // Masukkan konfigurasi Firebase (pastikan databaseURL sesuai environment kamu)
  const firebaseConfig = {
    apiKey: "AIzaSyCqgr3gYyc4oFg69xphOWPctvzgCisyL-I",
    authDomain: "game-tebak-angka-2025.firebaseapp.com",
    databaseURL: "https://game-tebak-angka-2025-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "game-tebak-angka-2025",
    storageBucket: "game-tebak-angka-2025.firebasestorage.app",
    messagingSenderId: "776244941517",
    appId: "1:776244941517:web:d9655d10c9532391084f84",
    measurementId: "G-S6NMHPNG7K"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth();

  // sign in anonymously so we can write/read DB
  signInAnonymously(auth).catch(e=> console.warn('Anon sign-in failed', e));
  onAuthStateChanged(auth, u=> { if(u) console.log('Signed in anon', u.uid); });

  // simple helpers
  const $ = id => document.getElementById(id);
  function makeRoomCode(){ return Math.random().toString(36).replace(/[^A-Z0-9]/ig,'').substring(2,7).toUpperCase(); }

  // expose generate function so inline UI can call it
  window.generateRoomCode = function(){ const code=makeRoomCode(); $('roomCode').textContent = code; sessionStorage.setItem('roomCode', code); }

  // show online setup screen when starting from UI
  window.goToOnlineSetup = async function(isHost){
    let code;
    if(isHost){ code = $('roomCode').textContent; if(!code || code==='—') { alert('Buat kode room dulu dengan Generate'); return; } }
    else { code = $('joinCode').value.trim().toUpperCase(); if(!code) { alert('Masukkan kode room untuk bergabung'); return; } }

    // simpan tipe role sementara
    sessionStorage.setItem('roomCode', code);
    sessionStorage.setItem('isHost', isHost? 'true':'false');

    // tampilkan modal setup sederhana (di dalam page)
    const html = `
      <div id="onlineSetupBox" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);width:320px;z-index:999;">
        <h3>Siapkan Nama & Secret</h3>
        <div>Room: <b id="onlineRoomDisplay">${code}</b></div>
        <input id="onlineName" placeholder="Nama kamu" style="margin-top:8px;width:100%;padding:8px;border-radius:8px;border:1px solid #ffd6e8;">
        <input id="onlineSecret" placeholder="Angka rahasiamu 4 digit" maxlength="4" style="margin-top:8px;width:100%;padding:8px;border-radius:8px;border:1px solid #ffd6e8;">
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
          <button id="onlineCancel">Batal</button>
          <button id="onlineStartBtn">Mulai</button>
        </div>
      </div>`;
    const wrapper = document.createElement('div'); wrapper.id='onlineSetupWrapper'; wrapper.innerHTML = html; document.body.appendChild(wrapper);

    $('onlineCancel').onclick = ()=>{ document.getElementById('onlineSetupWrapper')?.remove(); }
    $('onlineStartBtn').onclick = async ()=>{
      const name = $('onlineName').value.trim(); const secret = $('onlineSecret').value.trim();
      if(!name){ alert('Nama tidak boleh kosong'); return; }
      if(!/^[1-9]{4}$/.test(secret) || new Set(secret).size!==4){ alert('Secret harus 4 angka unik 1-9'); return; }

      try{
        if(isHost){ await createRoomOnFirebase(code, name, secret); alert('Room dibuat: '+code+'\nTunggu pemain bergabung'); }
        else { await joinRoomOnFirebase(code, name, secret); alert('Berhasil bergabung: '+code); }
        sessionStorage.setItem('onlineRoom', code); sessionStorage.setItem('onlineName', name); sessionStorage.setItem('onlineSecret', secret);
        document.getElementById('onlineSetupWrapper')?.remove();
      } catch(err){ alert('Gagal: '+(err.message || err)); }
    }
  }

  // Create room in DB
  async function createRoomOnFirebase(roomCode, playerName, secret){
    const roomRef = ref(db, 'rooms/' + roomCode);
    await set(roomRef, {
      host: { uid: auth.currentUser.uid, name: playerName, secret: secret },
      guest: null,
      state: 'waiting',
      turn: 'host',
      createdAt: serverTimestamp()
    });
    listenRoom(roomCode);
  }

  async function joinRoomOnFirebase(roomCode, playerName, secret){
    const roomRef = ref(db, 'rooms/' + roomCode);
    const snap = await get(roomRef);
    if(!snap.exists()) throw new Error('Room tidak ditemukan');
    const data = snap.val();
    if(data.guest) throw new Error('Room sudah penuh');
    await update(roomRef, { guest: { uid: auth.currentUser.uid, name: playerName, secret: secret }, state: 'playing' });
    listenRoom(roomCode);
  }

  // listen for room changes
  let roomUnsub = null;
  function listenRoom(roomCode){
    const rref = ref(db, 'rooms/' + roomCode);
    if(roomUnsub) roomUnsub();
    const off = onValue(rref, (snap)=>{ const room = snap.val(); onRoomUpdate(room, roomCode); });
    roomUnsub = ()=> off();
  }

  async function onRoomUpdate(room, code){
    if(!room) { alert('Room telah dihapus'); return; }
    const isHost = sessionStorage.getItem('isHost') === 'true';
    const role = isHost ? 'host' : 'guest';

    // update secret table (show _your_ secret only locally)
    const tbl = $('playerSecretTable'); tbl.innerHTML=''; const mySecret = isHost ? room.host?.secret : room.guest?.secret; const secShow = mySecret || '????'; for(const ch of secShow) { const d=document.createElement('div'); d.textContent=ch; tbl.appendChild(d); }

    // update histories
    $('playerHistory').innerHTML=''; $('opponentHistory').innerHTML='';
    if(room.hostHistory) Object.values(room.hostHistory).forEach(it=> $('playerHistory').innerHTML += `<div><span>${it.guess}</span> → ${it.result}</div>`);
    if(room.guestHistory) Object.values(room.guestHistory).forEach(it=> $('opponentHistory').innerHTML += `<div><span>${it.guess}</span> → ${it.result}</div>`);

    // change screens based on state
    if(room.state === 'waiting'){
      alert('Room dibuat, menunggu lawan. Kode: '+code);
      show('opponentTurn'); $('opponentTitle').textContent = 'Menunggu pemain bergabung...';
    } else if(room.state === 'playing'){
      const turn = room.turn; const myName = isHost ? room.host?.name : room.guest?.name; const oppName = isHost ? room.guest?.name : room.host?.name;
      if(turn === (isHost ? 'host' : 'guest')){
        $('playerTurnTitle').textContent = `Giliranmu — Tebak ${oppName || 'Lawan'}`; show('playerTurn');
      } else {
        $('opponentTitle').textContent = `Giliran ${oppName || 'Lawan'}`; $('opponentGuess').textContent = 'Menunggu...'; show('opponentTurn');
      }
    } else if(room.state === 'ended'){
      const winner = room.winner; const winnerName = winner === 'host' ? room.host?.name : room.guest?.name;
      alert(`${winnerName} menang!`);
      show('endScreen'); $('endMsg').textContent = winnerName + ' menang (Online)';
    }
  }

  // submit guess online
  window.submitGuessOnline = async function(guessStr){
    const code = sessionStorage.getItem('onlineRoom'); if(!code) return alert('Room tidak ada');
    const isHost = sessionStorage.getItem('isHost') === 'true'; const role = isHost? 'host':'guest';
    if(!/^[1-9]{4}$/.test(guessStr) || new Set(guessStr).size!==4) return alert('Tebakan harus 4 angka unik (1-9)');
    const roomSnap = await get(ref(db, 'rooms/'+code)); if(!roomSnap.exists()) return alert('Room tidak ditemukan');
    const room = roomSnap.val(); const opponentSecret = role==='host' ? room.guest?.secret : room.host?.secret; if(!opponentSecret) return alert('Lawan belum isi secret');
    const result = match(guessStr, opponentSecret);
    const histPath = role==='host' ? 'rooms/'+code+'/hostHistory' : 'rooms/'+code+'/guestHistory';
    const newRef = push(ref(db, histPath)); await set(newRef, { guess: guessStr, result: result, ts: serverTimestamp() });
    const roomRef = ref(db, 'rooms/' + code);
    if(result === 4){ await update(roomRef, { state: 'ended', winner: role }); }
    else { const next = role==='host' ? 'guest' : 'host'; await update(roomRef, { turn: next }); }
  }

  // wire UI events to functions
  document.getElementById('btnMakeStart').addEventListener('click', ()=> window.goToOnlineSetup(true));
  document.getElementById('btnJoinStart').addEventListener('click', ()=> window.goToOnlineSetup(false));

  // connect guess button to online function if online
  document.getElementById('guessBtn').addEventListener('click', ()=>{
    const isOnline = sessionStorage.getItem('onlineRoom');
    const g = [$('g1').value,$('g2').value,$('g3').value,$('g4').value].join('');
    if(isOnline) { window.submitGuessOnline(g).catch(e=>alert('Error: '+e.message)); $('g1').value=$('g2').value=$('g3').value=$('g4').value=''; return; }
  });

  // small cleanup when leaving
  window.addEventListener('beforeunload', ()=>{ const room = sessionStorage.getItem('onlineRoom'); if(room && confirm('Keluar akan membubarkan room?')){ remove(ref(db,'rooms/'+room)); } });

  // debug helper
  window._firebase={db,auth};

</script>

</body>
</html>
